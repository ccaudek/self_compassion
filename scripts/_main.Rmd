---
title: "Self-compassion, post-traumatic growth, and PTSD"
subtitle: "Outlier detection"
author: "[Corrado Caudek](https://ccaudek.github.io/)"
date: "Last modified `r format(Sys.time(), '%Y-%m-%d')`"
fontsize: 11pt
output:
  pdf_document: default
  html_document:
    df_print: paged
always_allow_html: yes
---


# Motivation

The purpose of the present script is to remove the outliers according to isolation forest algorithm.


# Prelims 

```{r}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  strip.white = TRUE
)

library("here")
suppressPackageStartupMessages(library("tidyverse"))
library("ggthemes")
suppressPackageStartupMessages(library("lavaan"))
suppressPackageStartupMessages(library("brms"))
suppressPackageStartupMessages(library("viridis"))
library("tidyr")
suppressPackageStartupMessages(library("mice"))
suppressPackageStartupMessages(library("corrplot"))
suppressPackageStartupMessages(library("bayesplot"))
suppressPackageStartupMessages(library("semPlot")) 
suppressPackageStartupMessages(library("rio")) 
suppressPackageStartupMessages(library("outForest"))
suppressPackageStartupMessages(library("semTools"))
suppressPackageStartupMessages(library("semoutput"))
suppressPackageStartupMessages(library("isotree"))

options(max.print = 99999999)

source(here("libraries", "self_compassion_fnc.R"))

# Read data 
temp <- rio::import(
  here("data", "processed", "rescue_workers.Rds"),
)

# remove uninformative variable
temp$is_rescue_worker <- NULL

# remove missing data on all questionnaires data (for convenience,
# I use the variable 'friends')
mydata <- temp[!is.na(temp$friends), ]
# summary(mydata)

mydata$years_experience <- as.numeric(as.character(mydata$years_experience))

# Multiple imputation

# MI for age
# select only the numeric columns of 'temp1'
nums <- unlist(lapply(mydata, is.numeric))
dat_num <- mydata[, nums]

# one value of 'years_experience' is miscoded: 2011;
# it will be recoded as NA and the multiply imputed and
# added again to the 'mydata' data.frame
dat_num$years_experience <- ifelse(
  dat_num$years_experience == 2011, NA, dat_num$years_experience
)

imp <- mice(
  dat_num,
  method = "midastouch",
  m = 1,
  maxit = 1,
  seed = 12345
)

d_imp <- complete(imp)
# summary(dat_num$age)
# summary(d_imp$age)

# add imputed 'age' to mydata
mydata$age_imp <- d_imp$age
mydata$years_experience <- d_imp$years_experience

rm(d_imp, dat_num, temp)

# Data wrangling
# Compute total score for MSPSS
mydata$mspss <- mydata$family + mydata$friends + mydata$significant_other

# Recode rate of activity as a numeric variable
mydata$activity_rate <- as.numeric(
  as.character(fct_recode(
    mydata$rate_of_activity,
    "5" = "Più di 1 turno a settimana",
    "4" = "1 turno a settimana",
    "3" = "1 turno ogni due settimane",
    "2" = "1 turno al mese",
    "1" = "Meno di 1 turno al mese"
  ))
)

# Recode education as a numeric variable
mydata$edu <- as.numeric(
  as.character(fct_recode(
    mydata$education,
    "1" = "Scuola media primaria",
    "2" = "Diploma",
    "3" = "Laurea breve",
    "4" = "Laurea magistrale",
    "5" = "Dottorato"
  ))
)

# Recode last_training as a numeric variable
mydata$training_time <- as.numeric(
  as.character(fct_recode(
    mydata$last_training,
    "1" = "Meno di 2 mesi fa",
    "2" = "Più di 2 mesi fa",
    "3" = "Meno di 6 mesi fa",
    "4" = "Più di 6 mesi fa",
    "5" = "Meno di 1 anno fa",
    "6" = "Più di 1 anno fa"
  ))
)

mydata$job_qualification <- fct_recode(
  mydata$job_qualification,
  "Soccorritore" = "Infermiere",
  "Soccorritore" = "Medico"
)

df <- mydata %>%
  drop_na(ptg)

df <- df %>%
  mutate(
    spirituality_changes = spirituality_changes * 3
  )
```


```{r}
df <- df %>% 
  mutate(
    red_cross_commeetee_location = 
      recode(red_cross_commeetee_location, 
             `Comitato del Medio Verbano` = "Comitato di Varese",
             `Comitato del Medio-Verbano` = "Comitato di Varese",
             `Comitato del Agrate` = "Comitato di Monza",
             `Comitato del Agrate Brianza` = "Comitato di Monza",
             `Comitato di Asola` = "Comitato di Mantova",
             `Comitato di Beragamo Hinterland` = "Comitato di Beragamo",
             `Comitato di Beragamo hinterland` = "Comitato di Beragamo",
             `Comitato di Bergamo Ovest e Valle Imagna` = "Comitato di Bergamo",
             `Comitato di Bresso` = "Comitato di Milano",
             `Comitato di Casorate Primo` = "Comitato di Pavia",
             `Comitato di Castiglione della Pescaia` = "Comitato di Grosseto",
             `Comitato di Cinisello balsamo` = "Comitato di Cinisello Balsamo",
             `Comitato di Desenzano` = "Comitato di Brescia",
             `Comitato di Empoli` = "Comitato di Firenze",
             `Comitato di Garbagnate Milanese` = "Comitato di Milano",
             `Comitato di Lentate Sul Seveso` = "Comitato di Monza",
             `Comitato di Lodigiano Ovest` = "Comitato di Lodi",
             `Comitato di Mede e Valle Lomellina` = "Comitato di Pavia",
             `Comitato di Palazzolo sull'oglio` = "Comitato di Palazzolo sull'Oglio",
             `Comitato di Palazzolo sull’Oglio` = "Comitato di Palazzolo sull'Oglio",
             `Comitato di Palazzolo Sull’Oglio` = "Comitato di Palazzolo sull'Oglio",
             `Comitato di Pistoia` = "Comitato di Firenze",
             `Comitato di Pitigliano` = "Comitato di Grosseto",
             `Comitato di Ponte a Egola` = "Comitato di Pisa",
             `Comitato di Ribolla` = "Comitato di Grosseto",
             `Comitato di Rignano sull'Arno` = "Comitato di Firenze",
             `Comitato di San donato milanese` = "Comitato di San Donato Milanese",
             `Comitato di San Giovanni alla Vena` = "Comitato di Pisa",
             `Comitato di Scarlino` = "Comitato di Grosseto",
             `Comitato di Seriate` = "Comitato di Bergamo",
             `Comitato di Strada in Chianti` = "Comitato di Firenze",
             `Comitato di Suvereto` = "Comitato di Livorno",
             `Comitato di Uliveto Terme` = "Comitato di Pisa",
             `Comitato di Valle Imagna` = "Comitato di Bergamo",
             `Comitato di Venturina Terme` = "Comitato di Livorno",
             `Comitato di Voghea` = "Comitato di Pavia",
             `Comitato di Volterra` = "Comitato di Pisa",
             `Comitato di Rosignano` = "Comitato di Firenze",
             `Comitato Di Bresso` = "Comitato di Milano",
             `Comitato di Beragamo` = "Comitato di Bergamo",
             `Comitato di Bergamo hinterland` = "Comitato di Bergamo",
             `Comitato di Agrate Brianza` = "Comitato di Monza",
             `Comitato di Agrate` = "Comitato di Monza",
             `Comitato di Vigevano` = "Comitato di Pavia",
             `Comitato di San Marcello Pistoiese` = "Comitato di Firenze",
             `Comitato di Pontasserchio` = "Comitato di Pisa",
             `Comitato di Mortara` = "Comitato di Pavia",
             `Comitato di Montorfano` = "Comitato di Como",
             `Comitato di Menaggio` = "Comitato di Como",
             `Comitato di Groane` = "Comitato di Monza",
             `Comitato di Follonica` = "Comitato di Grosseto",
             `Comitato di Cermenate` = "Comitato di Como",
             `Comitato di Castelfranco di Sotto` = "Comitato di Pisa",
             `Comitato di Buccinasco` = "Comitato di Milano",
             `Comitato di Buccinasco` = "Comitato di Milano",
             "Comitato di Beragamo" = "Comitato di Bergamo",
             `Comitato di Bagni di Lucca` = "Comitato di Lucca",
             `Comitato di Albiano Magra` = "Comitato di Firenze"
             )
    )

df$red_cross_commeetee_location <- factor(df$red_cross_commeetee_location)
```


Select important variables.

```{r}
vars <- c(
  # ptg
  "life_appreciation", "new_possibilities", "personal_strength",
  "spirituality_changes", "interpersonal_relationships",
  # ptsd
  "avoiding", "intrusivity", "iperarousal",
  # coping
  "social_support", "avoiding_strategies", "positive_attitude",
  "problem_orientation", "transcendent_orientation",
  # perceived social support
  "family", "friends", "significant_other",
  # self-compassion
  "self_judgment", "isolation", "over_identification",
  "self_kindness", "common_humanity", "mindfulness",
  # neuroticism
  "negative_affect", "self_reproach", "where", "age_imp",
  "rescue_worker_qualification", "rate_of_activity",
  ##
  "id", "where", "gender", "age_imp", "edu", "training_time", 
  "activity_rate", "employment", "red_cross_commeetee_location",
  "years_experience", "last_training", "job_qualification",
  "is_job_qualification_invariant", "is_team_invariant"  
)

temp1 <- df %>% 
  dplyr::select(vars)
```

Outliers detection.

```{r}
# temp <- temp1[temp1$age_imp > 20 & 
#                 temp1$rescue_worker_qualification == "Si" &
#                 temp1$rate_of_activity != "Meno di 1 turno al mese", ]

temp <- temp1[temp1$rescue_worker_qualification == "Si", ]

as_df <- isolation.forest(temp, nthreads = 1)
temp$anomaly_score <- predict(as_df, temp)
```

```{r}
hist(temp$anomaly_score)
```

Remove extreme observations.

```{r}
temp$outlier <- as.factor(ifelse(temp$anomaly_score >= 0.5, "outlier", "normal"))

clean_dat <- temp %>% 
  dplyr::filter(outlier == "normal")
```

```{r}
clean_dat %>% 
  group_by(where) %>% 
  summarise(
    n = n()
  )
```

```{r}
clean_dat[clean_dat$red_cross_commeetee_location == "Comitato di Beragamo", ]$red_cross_commeetee_location <- "Comitato di Bergamo"
```


```{r}
table(clean_dat$red_cross_commeetee_location)
```

```{r}
clean_dat <- clean_dat[!duplicated(clean_dat$id), ]
```


# Save cleaned data.

```{r}
saveRDS(clean_dat, here("data", "processed", "rescue_workers_cleaned_data.rds"))
```


<!--chapter:end:02_clean_data.Rmd-->

---
title: "Emergency psychology"
author: "[Corrado Caudek](https://ccaudek.github.io/)"
date: "First version 2019-02-14. Last modified `r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    fig_caption: yes
    highlight: pygments
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      smooth_scroll: FALSE
---

# Set up
```{r setup, include=FALSE}
suppressPackageStartupMessages(library("here"))
```


## Packages
```{r}
suppressPackageStartupMessages(library("googlesheets"))
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("lavaan"))
suppressPackageStartupMessages(library("mice"))  
```

Which google sheets do you have access to?
```{r}
# gs_ls()
```

Get the google sheet
```{r}
thedat <- gs_title("Sei un soccorritore in Emergenza? (Risposte)")
```

List worksheets
```{r}
gs_ws_ls(thedat)
```

Get data and convert to data.frame
```{r}
dat <- gs_read(ss=thedat, ws = "Risposte del modulo 1", skip=1)
df <- as.data.frame(dat)
```

Rename variables
```{r}
df <- df %>% 
  rename(
    date = `Informazioni cronologiche`,
    permission = `Trattamento dei dati personali`,
    id = `Inserisci il codice identificativo come sopra indicato:`,
    gender = Sesso,
    education = `Livello istruzione`,
    employment =  Occupazione,
    is_rescue_worker = `Sei un Soccorritore in Emergenza?`,
    red_cross_commeetee_location =  `Comitato Croce Rossa Italiana di appartenenza (per es. Comitato di Firenze)`,
    rescue_worker_qualification =  `Possiedi la qualifica TSSA/PTSI?`, 
    last_training = `Quando hai effettuato l'ultimo re-training, corso, inerente la qualifica TSSA/FULL-D?`,
    rate_of_activity =  `Con quale frequenza fai turno in Ambulanza?`,
    job_qualification =  `Generalmente fai turno sempre con la stessa squadra?`,
    is_job_qualification_invariant= `Generalmente fai turno sempre con la stessa squadra?`,
    age =  X231,
  ) 
```

The data.frame contains the following scales:

- NEO_FFI_60: 60 items, from X16 to X75. The NEO-FFI is a 60-item psychological personality inventory that assesses based on the five-factor model: Openness to Experience, Conscientiousness, Extraversion, Agreeableness, and Neuroticism. Participants are asked to select the response that best represents their opinion on a 5-point scale: 0-Strongly Agree, 1-Agree, 2-Neutral, 3-Disagree, 4-Strongly Disagree.

- COPE_NVI: 60 items, from X76 to X135. (Coping Orientation to Problems Experienced-Nuova Versione Italiana (COPE-NVI). The COPE-New Italian Version (COPE-NIV) represents an improvement of the previous Italian version of the COPE. La prima valutazione condotta è basata sulla media del punteggio totale del COPE-NVI. Tale punteggio è inteso come la somma dei punteggi attribuiti dai singoli rispondenti alle 60 domande. Il punteggio complessivo può essere considerato un indice di quanto la persona reagisca allo stress: maggiore è il punteggio, maggiore è il benessere psicologico di fronte a situazioni stressanti. Cinque dimensioni: Orientamento al problema, Attitudine positiva, Sostegno sociale, Evitamento, Orientamento trascendente.

- PTGI: 29 items, X136 to X143, X144 to X164. The Posttraumatic Growth Inventory was developed to assess positive outcomes in response totraumatic events. Five factors: Factor I: Relating to Others, Factor II: New Possibilities, Factor III: Personal Strength, Factor IV: Spiritual Change, and Factor V: Appreciation for Life.

- IES_R: 28 items, items X165 to X170, X171 to X192 (Impact of Event Scale - Revised). The IES-R is a 22-item self-report measure (for DSM-IV) that assesses subjective distress caused by traumatic events. It is a revised version of the older version, the 15-item IES (Horowitz, Wilner, & Alvarez, 1979). The IES-R contains seven additional items related to the hyperarousal symptoms of PTSD, which were not included in the original IES. Items correspond directly to 14 of the 17 DSM-IV symptoms of PTSD. Respondents are asked to identify a specific stressful life event and then indicate how much they were distressed or bothered during the past seven days by each "difficulty" listed. Items are rated on a 5-point scale ranging from 0 ("not at all") to 4 ("extremely"). The IES-R yields a total score (ranging from 0 to 88) and subscale scores can also be calculated for the Intrusion, Avoidance, and Hyperarousal subscales.

- SCS: 26 items, items X193 to 218. The  SCS (Neff,  2003a) is a 26-item  self-report  questionnaire measuring the six components of self-compassion: Self-Kindness(5 items; e.g., “I try to be loving towards myself when I’m feelingemotional pain”), reduced Self-Judgment (5 items; e.g., “I’m dis-approving  and  judgmental  about  my  own  flaws  and  inadequa-cies”), Common Humanity (4 items, e.g., “When things are goingbadly for me, I see the difficulties as part of life that everyone goesthrough”), reduced Isolation (4 items, e.g., “When I think about myinadequacies it tends to make me feel more separate and cut offfrom the rest of the world”), Mindfulness (4 items, e.g., “When I’mfeeling  down  I  try  to  approach  my  feelings  with  curiosity  andopenness”), and reduced Overidentification (4 items, e.g., “Whensomething upsets me I get carried away with my feelings”).

- MSPSS: 12 items, items X219 to 230 (Multidimensional Scale of Perceived Social Support, MSPSS). The MSPSS is a short instrument designed to measure an individual’s perception of support from 3 sources: family, friends and a significant other. To calculate total score: Sum across all 12 items. This total score can also be calculated as a mean score (divide by 12). To calculate the mean subscale scores:
Significant Other Subscale: Sum across items 1, 2, 5, & 10, then divide by 4.
Family Subscale: Sum across items 3, 4, 8, & 11, then divide by 4.
Friends Subscale: Sum across items 6, 7, 9, & 12, then divide by 4.



# Scala neo_ffi_60

Let start with the coding of neo_ffi_60. First, we select the right columns:
```{r}
neo_ffi_60 <- df %>% 
  select(X16:X75)
```

Then we change the column names to facilitate coding
```{r}
item_names <- paste0("i", 1:60)
names(neo_ffi_60) <- item_names
```

Some items are reversed. In that cases, we can compute the right value by using the following formula: abs(x - max).

The first factor of neo_ffi_60 is called neutoticism and is composed by two subscales. The scores on such scales are the following:

```{r}
negative_affect <- 
  abs(neo_ffi_60$i1 - 4) + neo_ffi_60$i11 + abs(neo_ffi_60$i16 - 4) + 
  abs(neo_ffi_60$i31 - 4) + abs(neo_ffi_60$i46 - 4)
```



```{r}
self_reproach <-
neo_ffi_60$i6 + neo_ffi_60$i21 + neo_ffi_60$i26 + neo_ffi_60$i36 + neo_ffi_60$i41 + neo_ffi_60$i51 + neo_ffi_60$i56
```

```{r}
neuroticism <- negative_affect + self_reproach
```

Just to take a look to the data, an histogram of neuroticism is
```{r}
hist(neuroticism)
```


The second factor of neo_ffi_60 is called extraversion and is composed by three subscales. The scores on such scales are the following:
```{r}
positive_affect <-
neo_ffi_60$i7 + abs(neo_ffi_60$i12 - 4) + neo_ffi_60$i37
 + abs(neo_ffi_60$i42 - 4)
```


```{r}
sociability <- 
neo_ffi_60$i2 + neo_ffi_60$i17 + abs(neo_ffi_60$i27 - 4) + abs(neo_ffi_60$i57 - 4)
```


```{r}
activity <- 
neo_ffi_60$i22 + neo_ffi_60$i32 + neo_ffi_60$i47 + neo_ffi_60$i52
```


```{r}
extraversion <- positive_affect + sociability + activity
```

Just to take a look to the data, an histogram of estraversion is
```{r}
hist(extraversion)
```


The third factor of neo_ffi_60 is called openness and is composed by three subscales. The scores on such scales are the following:
```{r}
aesthetic_interests <- 
neo_ffi_60$i13 + abs(neo_ffi_60$i23 - 4) + neo_ffi_60$i43
```


```{r}
intellectual_interests <- 
abs(neo_ffi_60$i48 - 4) + neo_ffi_60$i53 + neo_ffi_60$i58
```


```{r}
unconventionality <- 
abs(neo_ffi_60$i3 - 4) + abs(neo_ffi_60$i8 - 4) + abs(neo_ffi_60$i18 - 4) + abs(neo_ffi_60$i38 - 4)
```


```{r}
openness <- aesthetic_interests + intellectual_interests + unconventionality
```

Just to take a look to the data, an histogram of openness is
```{r}
hist(openness)
```


The fourth factor of neo_ffi_60 is called agreeableness and is composed by two subscales. The scores on such scales are the following:
```{r}
nonantagonistic_orientation <- 
abs(neo_ffi_60$i9 - 4) + abs(neo_ffi_60$i14 - 4) + neo_ffi_60$i19 +  abs(neo_ffi_60$i24 - 4) + abs(neo_ffi_60$i29 - 4) + abs(neo_ffi_60$i44 - 4) + abs(neo_ffi_60$i54 - 4) + abs(neo_ffi_60$i59 - 4)
```


```{r}
prosocial_orientation <- 
neo_ffi_60$i4 + neo_ffi_60$i34 + abs(neo_ffi_60$i39 - 4) + neo_ffi_60$i49
```


```{r}
agreeableness <- nonantagonistic_orientation + prosocial_orientation
```

Just to take a look to the data, an histogram of agreeableness is
```{r}
hist(agreeableness)
```


The fifth factor of neo_ffi_60 is called conscientiousness and is composed by three subscales. The scores on such scales are the following:
```{r}
orderliness <- 
neo_ffi_60$i5 +  neo_ffi_60$i10 + abs(neo_ffi_60$i15 - 4) + abs(neo_ffi_60$i30 - 4) + abs(neo_ffi_60$i55 - 4)
```


```{r}
goal_striving <- 
neo_ffi_60$i25 +  neo_ffi_60$i35 + neo_ffi_60$i60
```


```{r}
dependability <- 
neo_ffi_60$i20 +  neo_ffi_60$i40 + abs(neo_ffi_60$i45 - 4) + neo_ffi_60$i50
```


```{r}
conscientiousness <- orderliness + goal_striving + dependability
```

Just to take a look to the data, an histogram of conscientiousness is
```{r}
hist(conscientiousness)
```

# Scala COPE NVI

Let start with the coding of cope_nvi. First, we select the right columns:
```{r}
cope_nvi <- df %>% 
  select(X76:X135)
```

Then we change the column names to facilitate coding
```{r}
item_names <- paste0("ii", 1:60)
names(cope_nvi) <- item_names
```

Some items are reversed. In that cases, we can compute the right value by using the following formula: abs(x - max).

The first subscale of cope_nvi is called social support. The scores on such scales are the following:
```{r}
social_support <- 
cope_nvi$ii4 + cope_nvi$ii14 + cope_nvi$ii30 + cope_nvi$ii45 + cope_nvi$ii11 + cope_nvi$ii23 + cope_nvi$ii34 + cope_nvi$ii52 + cope_nvi$ii3 + cope_nvi$ii17 + cope_nvi$ii28 + cope_nvi$ii46
```

```{r}
hist(social_support)
```

The second subscale of cope_nvi is called avoiding strategies. The scores on such scale are the following:
```{r}
avoiding_strategies <- 
cope_nvi$ii6 + cope_nvi$ii27 + cope_nvi$ii40 + cope_nvi$ii57 + cope_nvi$ii9 + cope_nvi$ii24 + cope_nvi$ii37 + cope_nvi$ii51 + cope_nvi$ii2 + cope_nvi$ii16 + cope_nvi$ii31 + cope_nvi$ii43 +  cope_nvi$ii12 +  cope_nvi$ii26 +  cope_nvi$ii43 +  cope_nvi$ii35 +  cope_nvi$ii53
```

```{r}
hist(avoiding_strategies)
```

The third subscale of cope_nvi is called positive attitude. The scores on such scale are the following:
```{r}
positive_attitude <- 
cope_nvi$ii10 + cope_nvi$ii22 + cope_nvi$ii41 + cope_nvi$ii49 + cope_nvi$ii1 + cope_nvi$ii29 + cope_nvi$ii38 + cope_nvi$ii59 + cope_nvi$ii13 + cope_nvi$ii21 + cope_nvi$ii44 + cope_nvi$ii54
```

```{r}
hist(positive_attitude)
```

The fourth subscale of cope_nvi is called problem orientation. The scores on such scale are the following:
```{r}
problem_orientation <- 
cope_nvi$ii5 + cope_nvi$ii25 + cope_nvi$ii47 + cope_nvi$ii58 + cope_nvi$ii19 + cope_nvi$ii32 + cope_nvi$ii39 + cope_nvi$ii56 + cope_nvi$ii15 + cope_nvi$ii33 + cope_nvi$ii42 + cope_nvi$ii55
```

```{r}
hist(problem_orientation)
```

The fifth subscale of cope_nvi is called transcendent orientation. The scores on such scale are the following:
```{r}
transcendent_orientation <- 
abs(cope_nvi$ii8 - 5) + abs(cope_nvi$ii20 - 5) + abs(cope_nvi$ii36 - 5) + abs(cope_nvi$ii50 - 5) + cope_nvi$ii7 + cope_nvi$ii18 + cope_nvi$ii48 + cope_nvi$ii60
```

```{r}
hist(transcendent_orientation)
```


# Scala PTGI

Let start with the coding of ptgi. First, we select the right columns:
```{r}
ptgi1 <- df %>% 
  select(X136:X143)
```


```{r}
ptgi2 <- df %>% 
  select(X144:X164)
```

Then we change the column names to facilitate coding
```{r}
item_names <- paste0("it", 1:8)
names(ptgi1) <- item_names
```

COME CODIFICARE LE VARIABILI DI PTGI1??????

```{r}
item_names <- paste0("iii", 1:21)
names(ptgi2) <- item_names
```

```{r}
interpersonal_relationships <-
  ptgi2$iii15 + ptgi2$iii20 + ptgi2$iii9 + ptgi2$iii21 + ptgi2$iii8 + ptgi2$iii16 + ptgi2$iii6
```

```{r}
hist(interpersonal_relationships)
```


```{r}
new_possibilities <-
  ptgi2$iii11 + ptgi2$iii7 + ptgi2$iii3 + ptgi2$iii17 + ptgi2$iii14
```

```{r}
hist(new_possibilities)
```

```{r}
personal_strength <-
  ptgi2$iii10 + ptgi2$iii19 + ptgi2$iii4 + ptgi2$iii12
```

```{r}
hist(personal_strength)
```

```{r}
life_appreciation <-
  ptgi2$iii13 + ptgi2$iii2 + ptgi2$iii1
```

```{r}
hist(life_appreciation)
```


```{r}
spirituality_changes <-
  ptgi2$iii5 + ptgi2$iii18
```

```{r}
hist(spirituality_changes)
```


# Scala IES-R

Let start with the coding of ies_r. First, we select the right columns:
```{r}
ies_r1 <- df %>% 
  select(X165:X170)
```

```{r}
ies_r2 <- df %>% 
  select(X171:X192)
```


Then we change the column names to facilitate coding
```{r}
item_names <- paste0("iit", 1:6)
names(ies_r2) <- item_names
```

COME CODIFICARE QUESTI 6 ITEMS????


```{r}
item_names <- paste0("iiii", 1:22)
names(ies_r2) <- item_names
```


Il massimo punteggio medio di ognuna delle 3 subscale h 4, quindi il punteggio
medio totale massimo della scala IES-R h 12. Bassi punteggi sono migliori. Un
punteggio totale alla IES-R di 33 o superiore su un punteggio massimo di 88
significa la probabile presenza di un PTSD.


```{r}
avoiding <- 
  ies_r2$iiii5 + ies_r2$iiii7 + ies_r2$iiii8 + ies_r2$iiii11 + ies_r2$iiii12 + ies_r2$iiii13 + ies_r2$iiii17 + ies_r2$iiii22
```

```{r}
hist(avoiding)
```

```{r}
intrusivity <- 
  ies_r2$iiii1 + ies_r2$iiii2 + ies_r2$iiii3 + ies_r2$iiii6 + ies_r2$iiii9 + ies_r2$iiii14 + ies_r2$iiii16 + ies_r2$iiii20
```

```{r}
hist(intrusivity)
```

```{r}
iperarousal <-  
  ies_r2$iiii4 + ies_r2$iiii10 + ies_r2$iiii15 + ies_r2$iiii18 + ies_r2$iiii19 + ies_r2$iiii21
```

```{r}
hist(iperarousal)
```

```{r}
ies_r_score <- avoiding + intrusivity + iperarousal
```

```{r}
hist(ies_r_score)
```


I punteggi delle sottoscale del scs sono ottenuti calcolando la media delle risposte nei rispettivi item.
Quindi calcolare la media dei punteggi medi delle sei sottoscale. COME SI FA?


In this approach any mean scale score ranging from 1 to 2.9 could be considered low support; a score of 3 to 5 could be considered moderate support; a score from 5.1 to 7 could be considered high support. This approach would seem to have more
validity, but if you have very few respondents in any of the groups, it could be problematic.


# Scala SCS

Let start with the coding of scs. First, we select the right columns:
```{r}
scs <- df %>% 
  select(X193:X218)
```

Then we change the column names to facilitate coding
```{r}
item_names <- paste0("iiiii", 1:26)
names(scs) <- item_names
```

```{r}
self_kindness <- 
  scs$iiiii5 + scs$iiiii12 + scs$iiiii19 + scs$iiiii23 + scs$iiiii26
```

```{r}
hist(self_kindness)
```

```{r}
self_judgment <- 
  abs(scs$iiiii1 - 6) + abs(scs$iiiii8 - 6) + abs(scs$iiiii11 - 6) + abs(scs$iiiii16 - 6) + abs(scs$iiiii21 - 6)
```

```{r}
hist(self_judgment)
```

```{r}
common_humanity <- 
  scs$iiiii3 + scs$iiiii7 + scs$iiiii10 + scs$iiiii15
```

```{r}
hist(common_humanity)
```

```{r}
isolation <- 
  abs(scs$iiiii4 - 6) + abs(scs$iiiii13 - 6) + abs(scs$iiiii18 - 6) + abs(scs$iiiii25 - 6)
```

```{r}
hist(isolation)
```

```{r}
mindfulness <- 
  scs$iiiii9 + scs$iiiii14 + scs$iiiii17 + scs$iiiii22
```

```{r}
hist(mindfulness)
```

```{r}
over_identification <- 
  abs(scs$iiiii2 - 6) + abs(scs$iiiii6 - 6) + abs(scs$iiiii20 - 6) + abs(scs$iiiii24 - 6)
```

```{r}
hist(over_identification)
```


# Scala MSPSS

Let start with the coding of mspss. First, we select the right columns:
```{r}
mspss <- df %>% 
  select(X219:X230)
```

Then we change the column names to facilitate coding
```{r}
item_names <- paste0("iiiiii", 1:12)
names(mspss) <- item_names
```

```{r}
family <- 
  mspss$iiiiii3 + mspss$iiiiii4 + mspss$iiiiii8 + mspss$iiiiii11
```

```{r}
hist(family)
```

```{r}
friends <- 
  mspss$iiiiii6 + mspss$iiiiii7 + mspss$iiiiii9 + mspss$iiiiii12
```

```{r}
hist(friends)
```

```{r}
significant_other <-
  mspss$iiiiii1 + mspss$iiiiii2 + mspss$iiiiii5 + mspss$iiiiii10
```

```{r}
hist(significant_other)
```



# Replication of path model of Mattson, James, & Engdahl (2018) - Figure 2

Figure 2: 
Adaptive Coping 

```{r}
coping <- social_support + positive_attitude + problem_orientation + transcendent_orientation
ptg <- life_appreciation + new_possibilities + personal_strength + spirituality_changes + interpersonal_relationships

df <- data.frame(openness, coping, ptg)
```

## Multiple imputation

```{r}
temp_data <- mice(df, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data <- complete(temp_data, 1)

```

# Mediational analysis (1)

Here, we consider the path analysis model of Mattson, James, & Engdahl (2018) described in their Figure 2.

X: openness
Y: ptg
M: coping

```{r}
imp_data <- imp_data %>% 
  dplyr::rename(
    X = openness,
    Y = ptg,
    M = coping
  )
```


```{r}
model <- ' # direct effect
             Y ~ c*X
           # mediator
             M ~ a*X
             Y ~ b*M
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
```


```{r}
set.seed(1234)
fit1 <- sem(model, data = imp_data)
summary(fit1)
```


# Mediational analysis (2)


```{r}
df2 <- data.frame(extraversion, coping, ptg)
```

X: extraversion
Y: ptg
M: coping

## Multiple imputation

```{r}
temp_data_2 <- mice(df2, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data_2 <- complete(temp_data_2, 1)
```

```{r}
imp_data_2 <- imp_data_2 %>% 
  dplyr::rename(
    X = extraversion,
    Y = ptg,
    M = coping
  )
```

```{r}
model2 <- ' # direct effect
             Y ~ c*X
           # mediator
             M ~ a*X
             Y ~ b*M
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
```


```{r}
set.seed(1234)
fit2 <- sem(model2, data = imp_data_2)
summary(fit2)
```


# Replication of path model of Mattson, James, & Engdahl (2018) - Figure 3

```{r}
df <- data.frame(ies_r_score, neuroticism, avoiding_strategies)
```

## Multiple imputation

```{r}
temp_data <- mice(df, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data <- complete(temp_data, 1)
```

## Mediational analysis 

Here, we consider the path analysis model of Mattson, James, & Engdahl (2018) described in their Figure 3.

X: neuroticism
Y: ies_r_score
M: avoiding_strategies

```{r}
imp_data <- imp_data %>% 
  dplyr::rename(
    X = neuroticism,
    Y = ies_r_score,
    M = avoiding_strategies
  )
```


```{r}
model <- ' # direct effect
             Y ~ c*X
           # mediator
             M ~ a*X
             Y ~ b*M
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
```


```{r}
set.seed(1234)
fit3 <- sem(model, data = imp_data)
summary(fit3)
```



# Negative Self-compassion as mediating factor 

```{r}
neg_self_compassion <- self_judgment + isolation + over_identification
```


```{r}
df <- data.frame(ies_r_score, neuroticism, neg_self_compassion)
```

## Multiple imputation

```{r}
temp_data <- mice(df, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data <- complete(temp_data, 1)
```

## Mediational analysis 

Let us consider the path analysis model of Mattson, James, & Engdahl (2018) described in their Figure 3, but with negative self-compassion instead of maladaptive coping.


```{r}
imp_data <- imp_data %>% 
  dplyr::rename(
    X = neuroticism,
    Y = ies_r_score,
    M = neg_self_compassion
  )
```


```{r}
model <- ' # direct effect
             Y ~ c*X
           # mediator
             M ~ a*X
             Y ~ b*M
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
```


```{r}
set.seed(1234)
fit3 <- sem(model, data = imp_data)
summary(fit3)
```




# Positive Self-compassion as mediating factor 

```{r}
pos_self_compassion <- self_kindness + common_humanity + mindfulness
```


```{r}
df <- data.frame(ptg, extraversion, pos_self_compassion)
```

## Multiple imputation

```{r}
temp_data <- mice(df, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data <- complete(temp_data, 1)
```

## Mediational analysis 

Let us consider the path analysis model of Mattson, James, & Engdahl (2018) described in their Figure 2, but with positive self-compassion instead of adaptive coping.


```{r}
imp_data <- imp_data %>% 
  dplyr::rename(
    X = extraversion,
    Y = ptg,
    M = pos_self_compassion
  )
```


```{r}
model <- ' # direct effect
             Y ~ c*X
           # mediator
             M ~ a*X
             Y ~ b*M
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
```


```{r}
set.seed(1234)
fit3 <- sem(model, data = imp_data)
summary(fit3)
```




# Both negative self compassion and avoiding strategies as mediators

```{r}
neg_self_compassion <- self_judgment + isolation + over_identification
df <- data.frame(ies_r_score, neuroticism, avoiding_strategies, neg_self_compassion)
```

## Multiple imputation

```{r}
temp_data <- mice(df, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data <- complete(temp_data, 1)
```

## Mediational analysis 

We consider a path analysis model where both negative self-compassion and maladaptive coping are mediating factors

X: neuroticism
Y: ies_r_score
M: avoiding_strategies

```{r}
imp_data <- imp_data %>% 
  dplyr::rename(
    X = neuroticism,
    Y = ies_r_score,
    M1 = avoiding_strategies,
    M2 = neg_self_compassion
  )
```


```{r}
model <- ' # direct effect
             Y ~ c*X
           # mediator
             M1 ~ a*X
             Y ~ b*M1
             M2 ~ d*X
             Y ~ e*M2
           # indirect effect (a*b)
             ab := a*b 
             de := d*e
             abde := a*b + d*e
           # total effect
             total := c + (a*b) + (d*e)
         '
```


```{r}
set.seed(1234)
fit <- sem(model, data = imp_data)
summary(fit)
```














# Positive Self-compassion as causal source and extraversion as the mediating factor 

```{r}
pos_self_compassion <- self_kindness + common_humanity + mindfulness
```


```{r}
df <- data.frame(ptg, extraversion, pos_self_compassion)
```

## Multiple imputation

```{r}
temp_data <- mice(df, m=5, maxit=50, meth='pmm', seed=500)
```


```{r}
imp_data <- complete(temp_data, 1)
```

## Mediational analysis 

Let us consider the path analysis model of Mattson, James, & Engdahl (2018) described in their Figure 2, but with positive self-compassion instead of adaptive coping.


```{r}
imp_data <- imp_data %>% 
  dplyr::rename(
    X = pos_self_compassion ,
    Y = ptg,
    M = extraversion
  )
```


```{r}
model <- ' # direct effect
             Y ~ c*X
           # mediator
             M ~ a*X
             Y ~ b*M
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
```


```{r}
set.seed(1234)
fit3 <- sem(model, data = imp_data)
summary(fit3)
```



```{r}
cor.test(pos_self_compassion, coping, na.rm = TRUE)
```



```{r}
cor.test(neg_self_compassion, avoiding_strategies, na.rm = TRUE)
```


<!--chapter:end:05_summary_data.Rmd-->

---
title: "Self-compassion and post-traumatic growth"
author: "[Corrado Caudek](https://ccaudek.github.io/)"
date: "First version 2019-02-14. Last modified `r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    fig_caption: yes
    highlight: pygments
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      smooth_scroll: FALSE
---


```{r}
library("here")
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("lavaan"))
suppressPackageStartupMessages(library("mice"))
library("forcats")
```


```{r}
source(here("libraries", "self_compassion_fnc.R"))
```




```{r}
# To create the data, run:
# source(here("04_import_data.R"))
```


# Read data

```{r}
mydata <- read.csv(
  file=here("data", "rescue_workers.csv"), 
  header=TRUE, 
  sep=";"
)
```


# Replication of the path model of Mattson, James, & Engdahl (2018), fig. 2: Adaptive Coping 


```{r}
## Multiple imputation
# temp_data1 <- mice(df1, m=5, maxit=50, meth='pmm', seed=500, print = FALSE)
# imp_data1 <- complete(temp_data1, 1)
```


## Mediational analysis (1)

```{r}
d <- data.frame(
  x = mydata$openness, 
  m = mydata$cope_nvi, 
  y = mydata$ptg
)
d <- d[complete.cases(d), ]

print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```

Only indirect effect through COPE-NVI.


## Mediational analysis (2)

```{r}
d <- data.frame(
  x = mydata$extraversion, 
  m = mydata$cope_nvi, 
  y = mydata$ptg
)
d <- d[complete.cases(d), ]

print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```

Both direct effect than indirect effect though COPE-NVI.


## Mediational analysis (3)

```{r}
d <- data.frame(
  x = mydata$neuroticism, 
  m = mydata$cope_nvi, 
  y = mydata$ptg
)
d <- d[complete.cases(d), ]
print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```

Only indirect effect through coping.


## Mediational analysis (4)

```{r}
d <- data.frame(
  x = mydata$agreeableness, 
  m = mydata$cope_nvi, 
  y = mydata$ptg
)
d <- d[complete.cases(d), ]

print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```

Only indirect effect through coping.


## Mediational analysis (5)

```{r}
d <- data.frame(
  x = mydata$conscientiousness, 
  m = mydata$cope_nvi, 
  y = mydata$ptg
)
d <- d[complete.cases(d), ]
print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```

Both direct and indirect effects through coping.



## Mediational analysis (6)

Here, we consider the path analysis model of Mattson, James, & Engdahl (2018) 
described in their Figure 3.

X: neuroticism
Y: ies_r_score (assesses subjective distress caused by traumatic events)
M: avoiding_strategies (the second subscale of cope_nvi is called avoiding strategies)

```{r}
d <- data.frame(
  x = mydata$neuroticism, 
  m = mydata$avoiding_strategies,
  y = mydata$ies
)
d <- d[complete.cases(d), ]

print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```

Both direct and indirect effects.


## Self-compassion
### Negative Self-compassion as mediating factor 

Let us consider the path analysis model of Mattson, James, & Engdahl (2018) described in their Figure 3, but with negative self-compassion instead of maladaptive coping.

```{r}
d <- data.frame(
  x = mydata$neuroticism, 
  m = mydata$neg_self_compassion,
  y = mydata$ies
)
d <- d[complete.cases(d), ]
print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```




### Positive Self-compassion as mediating factor 

The path analysis model of Mattson, James, & Engdahl (2018) described in their 
Figure 2, but with positive self-compassion instead of adaptive coping.


```{r}
d <- data.frame(
  x = mydata$extraversion, 
  m = mydata$pos_self_compassion,
  y = mydata$ptg
)
d <- d[complete.cases(d), ]

print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```



### Positive Self-compassion as mediating factor with Openness

```{r}
d <- data.frame(
  x = mydata$openness, 
  m = mydata$pos_self_compassion,
  y = mydata$ptg
)
d <- d[complete.cases(d), ]
print(cor(d), 3)

m <- mediation_an_1(d)
summary(m)
```


### Negative self-compassion and maladaptive coping as mediators

We consider a path analysis model where both negative self-compassion and 
maladaptive coping are mediating factors:

- X: neuroticism
- Y: ies_r_score
- M1: avoiding_strategies
- M2: neg_self_compassion

```{r}
d <- data.frame(
  y = mydata$ies, 
  m1 = mydata$avoiding_strategies, 
  m2 = mydata$neg_self_compassion,
  x = mydata$neuroticism
)
d <- d[complete.cases(d), ]

print(cor(d), 3)

m <- mediation_an_2(d)
summary(m)
```



### Negative and positive self compassion as mediators

We consider a path analysis model where both negative self-compassion and 
positive self-compassion are mediating factors:


```{r}
d <- data.frame(
  x  = mydata$neuroticism, 
  m1 = mydata$pos_self_compassion, 
  m2 = mydata$neg_self_compassion,
  y  = mydata$ies
)
d <- d[complete.cases(d), ]
print(cor(d), 3)

m <- mediation_an_2(d)
summary(m)
```















<!-- # Self Compassion is the same of coping strategies? -->

<!-- ```{r} -->
<!-- cor.test(pos_self_compassion, coping, na.rm = TRUE) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- plot(pos_self_compassion, coping) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- cor.test(neg_self_compassion, avoiding_strategies, na.rm = TRUE) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- plot(neg_self_compassion, avoiding_strategies) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- self_compassion <- self_judgment + self_kindness + common_humanity + -->
<!--   isolation + over_identification + mindfulness -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(self_compassion) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(pos_self_compassion) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(neg_self_compassion) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- summary(avoiding_strategies) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$gender <- fct_recode( -->
<!--   df$gender, -->
<!--   "female" = "Femmina", -->
<!--   "male" = "Maschio" -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$employment <- fct_recode( -->
<!--   df$employment, -->
<!--   "Dipendente" = "Operaio", -->
<!--   "Dipendente" = "Impiegato", -->
<!--   "Libero professionista" = "Imprenditore", -->
<!--   "Dipendente" = "Dipendente CRI", -->
<!--   "Dipendente" = "Infermiere", -->
<!--   "Dipendente" = "Militare", -->
<!--   "Dipendente" = "Vigile del Fuoco", -->
<!--   "Pensionato" = "pensionato", -->
<!--   "Dipendente" = "Funzionario Pubblico", -->
<!--   "Dipendente" = "Forze dell'Ordine", -->
<!--   "Dipendente" = "Ricercatore", -->
<!--   "Libero professionista" = "Commerciante", -->
<!--   "Dipendente" = "Educatore", -->
<!--   "Dipendente" = "Soccorritore", -->
<!--   "Dipendente" = "Polizia locale", -->
<!--   "Dipendente" = "Polizia Locale", -->
<!--   "Studente" = "Dottoranda", -->
<!--   "Dipendente" = "Medico", -->
<!--   "Pensionato" = "Pensione", -->
<!--   "Dipendente" = "Insegnante" -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$is_rescue_worker <- fct_recode( -->
<!--   df$is_rescue_worker, -->
<!--   "Yes" = "Sì", -->
<!--   "Yes" = "Si" -->
<!-- ) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- df <- df %>% -->
<!--   dplyr::rename( -->
<!--     years_experience = `Anni di esperienza TSSA/PTSI (inserire il numero)` -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$last_training <- factor( -->
<!--   df$last_training, -->
<!--   levels = c( -->
<!--     "Più di 1 anno fa", "Meno di 1 anno fa", "Più di 6 mesi fa", "Meno di 6 mesi fa", -->
<!--     "Più di 2 mesi fa", "Meno di 2 mesi fa" -->
<!--   ) -->
<!-- ) -->
<!-- unique(df$last_training) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$rate_of_activity <- factor( -->
<!--   df$rate_of_activity, -->
<!--   levels = c( -->
<!--     "1 turno al mese", "Meno di 1 turno al mese", "1 turno ogni due settimane", -->
<!--     "1 turno a settimana", "Più di 1 turno a settimana" -->
<!--   ) -->
<!-- ) -->
<!-- unique(df$rate_of_activity) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- unique(df$job_qualification) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$is_job_qualification_invariant <- fct_recode( -->
<!--   df$is_job_qualification_invariant, -->
<!--   "Yes" = "Sì", -->
<!--   "Yes" = "Si" -->
<!-- ) -->
<!-- table(df$is_job_qualification_invariant) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- df$is_team_invariant <- fct_recode( -->
<!--   df$is_team_invariant, -->
<!--   "Yes" = "Sì", -->
<!--   "Yes" = "Si" -->
<!-- ) -->
<!-- table(df$is_team_invariant) -->
<!-- ``` -->


<!-- # Data frame finale -->

<!-- ```{r} -->
<!-- thedat1 <- data.frame( -->
<!--   where = factor(df$where), -->
<!--   id = factor(df$id), -->
<!--   gender = factor(df$gender), -->
<!--   age = df$age, -->
<!--   education = factor(df$education), -->
<!--   employment = factor(df$employment), -->
<!--   is_rescue_worker = factor(df$is_rescue_worker), -->
<!--   red_cross_commeetee_location = factor(df$red_cross_commeetee_location), -->
<!--   rescue_worker_qualification = factor(df$rescue_worker_qualification), -->
<!--   years_experience = factor(df$years_experience), -->
<!--   last_training = factor(df$last_training), -->
<!--   rate_of_activity = factor(df$rate_of_activity), -->
<!--   job_qualification = factor(df$job_qualification), -->
<!--   is_job_qualification_invariant = factor(df$is_job_qualification_invariant), -->
<!--   is_team_invariant = factor(df$is_team_invariant), -->
<!--   neuroticism, -->
<!--   extraversion, -->
<!--   openness, -->
<!--   agreeableness, -->
<!--   conscientiousness, -->
<!--   coping, -->
<!--   ptg, -->
<!--   ies = ies_r_score, -->
<!--   neg_self_compassion, -->
<!--   pos_self_compassion, -->
<!--   family, -->
<!--   friends, -->
<!--   significant_other -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- thedat <- thedat1 %>% -->
<!--   dplyr::filter(is_rescue_worker == "Yes") -->

<!-- # thedat <- thedat2[complete.cases(thedat2), ] -->
<!-- ``` -->

<!-- ```{r} -->
<!-- saveRDS(thedat, file = "rescue_worker.Rds") -->

<!-- write.table( -->
<!--   thedat, -->
<!--   file = "rescue_worker.csv", -->
<!--   sep = ";", -->
<!--   row.names = FALSE -->
<!-- ) -->
<!-- ``` -->



<!--chapter:end:10_med_lavaan.Rmd-->

---
title: "Self-compassion, post-traumatic growth, and PTSD"
author: "[Corrado Caudek](https://ccaudek.github.io/)"
date: "Last modified `r format(Sys.time(), '%Y-%m-%d')`"
fontsize: 11pt
output:
  pdf_document: default
  html_document:
    df_print: paged
always_allow_html: yes
---

# Motivation

Self-compassion (SC) has been proposed as a protective factor against PTSD and a factor promoting PTG.

One limit of these studies, however, is that they have often been performed in student populations, that is, in samples in which, supposedly, PTSD and PTG are only present in mild forms, if ever.

Moreover, in recent years, the role of SC has been questioned. For example, Muris, Otgaar and Pfattheicher (2019) maintain that SC is strongly associated with (reversed) Negative Affect and that, once the negative component of SC is removed, the added value of positive SC is marginal.

Furthermore, Geiger, Pfattheicher, Hartung, Weiss, Schindler, and Wilhelm (2018) have  questioned the fact that SC is a construct that does not overlap with Neuroticism. Once Neuroticism is controlled, there is no evidence of a specific contribution of SC.

The purpose of the present study is to evaluate the hypotheses of Muris et al. (2019) and of Geiger et al. (2018) in a sample of rescue workers.


# Prelims 

```{r}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  strip.white = TRUE
)

library("here")
suppressPackageStartupMessages(library("lavaan"))
suppressPackageStartupMessages(library("brms"))
suppressPackageStartupMessages(library("tidyverse"))
library("ggthemes")
suppressPackageStartupMessages(library("viridis"))
library("tidyr")
suppressPackageStartupMessages(library("mice"))
suppressPackageStartupMessages(library("corrplot"))
suppressPackageStartupMessages(library("bayesplot"))
suppressPackageStartupMessages(library("semPlot"))
suppressPackageStartupMessages(library("rio"))
suppressPackageStartupMessages(library("outForest"))
suppressPackageStartupMessages(library("semTools"))
suppressPackageStartupMessages(library("semoutput"))
suppressPackageStartupMessages(library("isotree"))

options(max.print = 99999999)

source(here("libraries", "self_compassion_fnc.R"))
```


```{r}
temp <- readRDS(here("data", "processed", "rescue_workers_cleaned_data.rds"))
clean_dat <- temp %>% 
  dplyr::filter(age_imp > 20)
```


```{r}
psych::describe(clean_dat)
```


Because of kurtosis for a sub-scale of PTG, robust estimation procedure with the Satorra-Bentler corrections were used. 


```{r}
hist(clean_dat$spirituality_changes)
```

# Model 0 

M0 hypothesizes no effect of self-compassion. 

```{r}
model0 <- "
  # measurement model
  
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
          personal_strength + spirituality_changes + 
          interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ social_support + avoiding_strategies + 
          positive_attitude + problem_orientation + 
          transcendent_orientation
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc  
  ptss ~ cope + soc 
  
  sc ~~ neuro
  soc ~~ cope
  soc ~~ sc
  soc ~~ neuro
  cope ~~ sc
  cope ~~ neuro

  self_judgment ~~ self_kindness
  # spirituality_changes ~~ transcendent_orientation
  "
```



# Fit

```{r}
fit0 <- lavaan::sem(
  model0,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
summary(
  fit0,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```



# Model 1 

M1 hypothesizes that both PTG and PTSD are affected by coping strategies, by social support and by self-compassion. M1 does not distinguish between the two components of self-compassion. Modification indices suggest to add a residual correlation between spirituality_changes and transcendent_orientation.

```{r}
model1 <- "
  # measurement model
  
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
          personal_strength + spirituality_changes + 
          interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ social_support + avoiding_strategies + 
          positive_attitude + problem_orientation + 
          transcendent_orientation
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc + sc 
  ptss ~ cope + soc + sc 
  
  sc ~~ neuro
  soc ~~ cope
  soc ~~ sc
  soc ~~ neuro
  cope ~~ sc
  cope ~~ neuro

  self_judgment ~~ self_kindness
  # spirituality_changes ~~ transcendent_orientation
  "
```



# Fit

```{r}
fit1 <- lavaan::sem(
  model1,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
anova(fit1, fit0)
```


```{r}
summary(
  fit1,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```


```{r}
fitMeasures(fit1)
```


```{r}
semPaths(
  fit1, 
  "std",
  edge.label.cex = 0.75, 
  curvePivot = TRUE, 
  title = TRUE,
  fade = FALSE
)
```

Interpretation: the fit is bad.


# Model 1a 

M1a does not distinguish between the two components of self-compassion and consider only a subset of dimensions of coping, because Coping was poorly defined by such indicators.

```{r}
model1a <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  sc ~~ neuro
  soc ~~ cope
  soc ~~ sc
  soc ~~ neuro
  cope ~~ sc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + sc 
  ptss ~ cope + soc + sc 
  
  self_judgment ~~ self_kindness
"
```

Fit

```{r}
fit1a <- lavaan::sem(
  model1a,
  data = mydat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
summary(
  fit1a,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```

```{r}
fitMeasures(fit1a)
moreFitIndices(fit1a)
```



Interpretation: the fit is still bad: the ration between $\chi^2 / df$ is equal to `r round(1368.873 /141.000, 2)`.

```{r}
compareFit(fit1, fit1a, nested = TRUE)
```

```{r}
anova(fit1, fit1a)
```


# Model 2 

M2 distinguishes between the two components of self-compassion and uses only a subset of the coping dimensions to improve the fit.

```{r}
model2 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   # + transcendent_orientation + avoiding_strategies + social_support 
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + nsc + psc 
  ptss ~ cope + soc + nsc + psc 

  self_judgment ~~ self_kindness
  # spirituality_changes ~~ transcendent_orientation
  
"
```

```{r}
fit2 <- sem(
  model2,
  data = mydat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
varTable(fit2)
```

```{r}
summary(
  fit2,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```


```{r}
fitMeasures(fit2)
```


```{r}
parTable(fit2)
```

```{r}
standardizedSolution(fit2, type = "std.all")
```

Interpretation: the fit is good: the ratio between $\chi^2 / df$ is `r round(584.17 / 136.000, 2)`.

```{r}
anova(fit1a, fit2)
```

```{r}
compareFit(fit2, fit1a, nested = TRUE)
```


# Model 3 

Remove the effect of the negative component of self-compassion.

```{r}
model3 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc + psc 
  ptss ~ cope + soc + psc 
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro

  self_judgment ~~ self_kindness
"
```

```{r}
fit3 <- sem(
  model3,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
summary(
  fit3, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```

```{r}
fitMeasures(fit3)
```

## Comparison between M2 and M3

```{r}
anova(fit2, fit3)
```

There is a significant loss of fit. Interpretation: the negative component of self-compassion is important.


# Model 3a {.tabset}

Remove the effect of the positive component of self-compassion.

```{r}
model3a <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc + nsc 
  ptss ~ cope + soc + nsc 
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro

  self_judgment ~~ self_kindness
"
```


```{r}
fit3a <- sem(
  model3a,
  data = df,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
summary(
  fit3a, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```

```{r}
fitMeasures(fit3a)
```

The fit is good: the ratio between $\chi^2 / df$ = `r round(590.538 / 138.000 , 2)`.


## Comparison between M2 and M3a

```{r}
anova(fit2, fit3a)
```

Interpretation: there is no loss of fit if the positive component of self-compassion is removed.


# Model 4 {.tabset}

Considering also the influence of personality factors.

```{r}
model4 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # ffi
  ffi =~ neuroticism + extraversion + conscientiousness +
         openness + agreeableness 

  # regressions
  ptgr ~ cope + soc + nsc + psc + ffi
  ptss ~ cope + soc + nsc + psc + ffi
  # ffi ~ ptg + ptss
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro

  self_judgment ~~ self_kindness
  # spirituality_changes ~~ transcendent_orientation
"
```


```{r}
fit4 <- sem(
  model4,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
summary(
  fit4, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```

```{r}
fitMeasures(fit4)
```

Models 2 and 4 are not nested, therefore a chi-square difference test is not meaningful.

Also after removing openness + agreeableness, which have low loadingson ffi, the regression coefficients associated to ffi are not statistically significant. I conclude that there is no obvious effect of personality factors in the relation between self compassion and ptg and ptss.


<!-- # Model 5 {.tabset} -->

<!-- M5 considers the role of Neuroticism, together with self-compassion. -->

<!-- ```{r} -->
<!-- model5 <- " -->
<!--   # post-traumatic growth -->
<!--   ptgr =~ life_appreciation + new_possibilities +  -->
<!--           personal_strength + spirituality_changes +  -->
<!--           interpersonal_relationships -->

<!--   # ptsd -->
<!--   ptss =~ avoiding + intrusivity + iperarousal -->

<!--   # coping -->
<!--   cope =~ positive_attitude + problem_orientation  -->

<!--   # perceived social support -->
<!--   soc =~ family + friends + significant_other -->

<!--   # self-compassion -->
<!--   nsc =~ self_judgment + isolation + over_identification -->
<!--   psc =~ self_kindness + common_humanity + mindfulness -->

<!--   # neuroticism -->
<!--   neuro =~ negative_affect + self_reproach -->

<!--   # regressions -->
<!--   ptgr ~ cope + soc + nsc + psc + neuro -->
<!--   ptss ~ cope + soc + nsc + psc + neuro -->

<!--   psc ~~ nsc -->

<!--   self_judgment ~~ self_kindness -->
<!-- " -->
<!-- ``` -->

<!-- ```{r} -->
<!-- fit5 <- sem( -->
<!--   model5, -->
<!--   data = df, -->
<!--   estimator = "MLM", -->
<!--   std.lv = TRUE -->
<!-- ) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- summary( -->
<!--   fit5,  -->
<!--   standardized = TRUE,  -->
<!--   fit.measures = TRUE,  -->
<!--   rsquare = TRUE -->
<!-- ) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- fitMeasures(fit5) -->
<!-- ``` -->

<!-- The fit is good: the ratio between $\chi^2 / df$ = `round(1412.650 / 410.000, 2)`. -->




# Model 6 

A model with Neuroticism and self-compassion.

```{r}
model6 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + nsc + psc + neuro
  ptss ~ cope + soc + nsc + psc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
  # data = df[df$age_imp > 21 & df$rescue_worker_qualification == "Si" &
  #             df$rate_of_activity != "Meno di 1 turno al mese", ],
```



```{r}
fit6 <- sem(
  model6,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
summary(
  fit6, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```

```{r}
fitMeasures(fit6)
```


# Model 7 

Model 7 remove self-compassion from Model 6.

```{r}
model7 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptss
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # regressions
  ptgr ~ cope + soc + neuro
  ptss ~ cope + soc + neuro
  
# covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit7 <- sem(
  model7,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
summary(
  fit7, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```


```{r}
fitMeasures(fit7)
```

The fit is very good: the ratio $\chi^2 / df$ = `round(252.942 / 80.000, 2)`. All other indices of fit are excellent.


```{r}
semPaths(
  fit7, 
  "std",
  edge.label.cex = 0.75, 
  curvePivot = TRUE, 
  title = TRUE,
  fade = FALSE
)
```

## Comparison between M6 and M7

The comparison between the model with both Neuroticism and Self-Compassion (M6) and the model from which the regression effect of Self-Compassion has been removed (M7) shows that M6 provides a better fit:


```{r}
anova(fit6, fit7)
```



# Model 8 

A model with Neuroticism but no negative component of self-compassion.

```{r}
model8 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + psc + neuro
  ptss ~ cope + soc + psc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit8 <- sem(
  model8,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
anova(fit6, fit8)
```

```{r}
summary(
  fit8, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```

# Model 9 

A model with Neuroticism but no positive component of self-compassion.

```{r}
model9 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + nsc + neuro
  ptss ~ cope + soc + nsc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit9 <- sem(
  model9,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
anova(fit6, fit9)
```



# Measurement invariance


```{r}
model_invariance <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + nsc + psc + neuro
  ptss ~ cope + soc + nsc + psc + neuro
  
"
```


```{r}
step1_comb_mean <- lavaan::sem(
  data = clean_dat, 
  model = model_invariance,
  estimator = "MLM",
  group = "where")
```


```{r}
step2_comb_mean <- lavaan::sem(
  data=clean_dat, 
  model=model_invariance,
  group="where", estimator="MLM",
  group.equal=c("loadings")
)
```

```{r}
step3_comb_mean <- lavaan::sem(
  data=clean_dat, 
  model=model_invariance,
  group="where", 
  estimator="MLM",
  group.equal=c("loadings", "intercepts")
)
```

```{r}
step4_comb_mean <- lavaan::sem(
  data=clean_dat, 
  model=model_invariance,
  group="where", estimator="MLM",
  group.equal=c("loadings", "intercepts", "residuals")
)
```

```{r}
compareFit(step1_comb_mean, step2_comb_mean, step3_comb_mean, step4_comb_mean)
```
```{r}
anova(step1_comb_mean, step2_comb_mean, step3_comb_mean, step4_comb_mean)
```

```{r}
anova(step1_comb_mean, step4_comb_mean)
```


# Conclusion {.tabset}

There are two main conclusions.

- From a model that provides an adequate fit to the data, the removal of the positive component of Self-Compassion has the consequence of improving the model's fit. This result questions the contribution of the *added value* of the specific component of Self-Compassion (i.e., the positive component of SC) on the relation between PTG and PTSD. Such result is consistent with the proposal of Muris, Otgaar, and Pfattheicher (2019).  Differently from previous studies, our results show that the hypothesis of Muris et al. (2019) holds also in a sample of individuals in which PTG and PTSD play an important role (i.e., rescue workers) and not only in a student sample.

- The supposed *added value* of Self-Compassion is also questioned by the comparison between M7 and M6, which shows that a model including Neuroticism provides a better fit than a model with both Neuroticism and Self-Compassion. This result is consistent with the proposal of Geiger et al. (2018).

Together, our results strongly questioned the role of Self-Compassion as a protective factor against PTSD and promoting PTG.


# Research Question 10
## Is a mediation model adequate for the effect of Self-Compassion on PTG and PTSD?

Shame and Depressive Symptoms: Self-compassion and Contingent Self-worth as Mediators?
Huaiyu Zhang, Erika R. Carr, Amanda G. Garcia-Williams, Asher E. Siegelman, Danielle Berke, Larisa V. Niles-Carnes, Bobbi Patterson, Natalie N. Watson-Singleton & Nadine J. Kaslow 
Journal of Clinical Psychology in Medical Settings volume 25, pages 408--419 (2018) 

Perfectionism, (self-)compassion, and subjective well-being: A mediation model
JoachimStoeberAneta V.LalovaEllen J.Lumley
Personality and Individual Differences
Volume 154, 1 February 2020, 109708

Self-compassion as mediator between coping and social anxiety in late adolescence: A longitudinal analysis
Catrinel A.Ștefan
Journal of Adolescence
Volume 76, October 2019, Pages 120-128



```{r}
mod_med_1 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ g1*cope + g2*soc + g3*neuro
  ptss ~ t1*cope + t2*soc + t3*neuro
  
  psc ~ p1*cope + p2*soc + p3*neuro
  nsc ~ n1*cope + n2*soc + n3*neuro
  
  ptgr ~ dg1*psc + dg2*nsc
  ptss ~ dt1*psc + dt2*nsc
  
  # covariances
  psc ~~ nsc
  soc ~~ cope
  soc ~~ neuro
  cope ~~ neuro

  self_judgment ~~ self_kindness
  
  # indirect effect 
  ip_g := (p1*dg1 + p1*dg2) + (p2*dg1 + p2*dg2) + (p3*dg1 + p3*dg2) 
  in_g := (n1*dg1 + n1*dg2) + (n2*dg1 + n2*dg2) + (n3*dg1 + n3*dg2) 
  i_g  := ip_g + in_g

  ip_t := (p1*dt1 + p1*dt2) + (p2*dt1 + p2*dt2) + (p3*dt1 + p3*dt2) 
  in_t := (n1*dt1 + n1*dt2) + (n2*dt1 + n2*dt2) + (n3*dt1 + n3*dt2) 
  i_t  := ip_t + in_t
  
  # total effect
  tot_g := g1 + g2 + g3 + i_g
  tot_t := t1 + t2 + t3 + i_t
  
"
```

```{r}
fit10 <- sem(
  mod_med_1,
  data = clean_dat,
  estimator = "ML",
  std.lv = TRUE
)
```

```{r}
summary(
  fit10, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```


```{r}
mod_med_2 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ g1*cope + g2*soc + g3*psc + g4*nsc
  ptss ~ t1*cope + t2*soc + t3*psc + t4*nsc
  
  neuro ~ n1*cope + n2*soc + n3*psc + n4*nsc

  ptgr ~ dn1*neuro
  ptss ~ dn2*neuro
  
  # covariances
  self_judgment ~~ self_kindness
  
  # indirect effect 
  i_g := n1*dn1 + n2*dn1 + n3*dn1 + n4*dn1 
  i_t := n1*dn2 + n2*dn2 + n3*dn2 + n4*dn2 
  
  # total effect
  tot_g := g1 + g2 + g3 + g4 + i_g
  tot_t := t1 + t2 + t3 + t4 + i_t
  
"
```

```{r}
fit11 <- sem(
  mod_med_2,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
summary(
  fit11, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```

# Three components of positive self-compassion only as a mediator

```{r}
mod_med_3 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  # psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ g1*cope + g2*soc + g3*neuro
  ptss ~ t1*cope + t2*soc + t3*neuro
  
  self_kindness   ~ k1*cope + k2*soc + k3*neuro
  common_humanity ~ h1*cope + h2*soc + h3*neuro
  mindfulness     ~ m1*cope + m2*soc + m3*neuro

  ptgr ~ dir_kg*self_kindness + dir_hg*common_humanity + dir_mg*mindfulness
  ptss ~ dir_kt*self_kindness + dir_ht*common_humanity + dir_mt*mindfulness
  
  # indirect effect
  ig_k := (k1*dir_kg) + (k2*dir_kg) + (k3*dir_kg)
  ig_h := (h1*dir_hg) + (h2*dir_hg) + (h3*dir_hg)
  ig_m := (m1*dir_mg) + (m2*dir_mg) + (m3*dir_mg)
  i_g  := ig_k + ig_h + ig_m

  it_k := (k1*dir_kt) + (k2*dir_kt) + (k3*dir_kt)
  it_h := (h1*dir_ht) + (h2*dir_ht) + (h3*dir_ht)
  it_m := (m1*dir_mt) + (m2*dir_mt) + (m3*dir_mt)
  i_t  := it_k + it_h + it_m

  # total effect
  tot_kg := dir_kg + ig_k
  tot_hg := dir_hg + ig_h
  tot_mg := dir_mg + ig_m
  tot_g := dir_kg + dir_hg + dir_mg + i_g
  
  tot_kt := dir_kt + it_k
  tot_ht := dir_ht + it_h
  tot_mt := dir_mt + it_m
  tot_t := dir_kt + dir_ht + dir_mt + i_t
  
"
```

```{r}
fit12 <- sem(
  mod_med_3,
  data = clean_dat,
  estimator = "ML",
  std.lv = TRUE
)
```

```{r}
summary(
  fit12, 
  standardized = TRUE, 
  fit.measures = TRUE, 
  rsquare = TRUE
)
```





# Regressions

```{r}
hist(df$ptg)
```


```{r}
fm <- lm(ptg ~ gender + education + age + employment + 
           years_experience + last_training + rate_of_activity +
           job_qualification + is_job_qualification_invariant +
           is_team_invariant,
         data = df)

summary(fm)
car::Anova(fm)
```

```{r}
car::outlierTest(fm)
```

```{r}
car::influenceIndexPlot(fm)
```


```{r}
ggResidpanel::resid_panel(fm)
```

```{r}
boxplot(df$ptg ~ df$gender)
```

```{r}
df$PTSD <- with(df, 1 + avoiding + intrusivity + iperarousal)
hist(log(df$PTSD + 1))
```


```{r}
fm1 <- lm(log(PTSD) ~ gender + education + age + employment + 
           years_experience + last_training + rate_of_activity +
           job_qualification + is_job_qualification_invariant +
           is_team_invariant,
         data = df)

summary(fm1)
car::Anova(fm1)
```

```{r}
car::outlierTest(fm1)
```

```{r}
car::influenceIndexPlot(fm1)
```

```{r}
ggResidpanel::resid_panel(fm1)
```


# References

Geiger, M., Pfattheicher, S., Hartung, J., Weiss, S., Schindler, S., & Wilhelm, O. (2018). Self‐Compassion as a Facet of Neuroticism? A Reply to the Comments of Neff, Tóth‐Király, and Colosimo (2018). *European Journal of Personality*, *32*(4), 393-404.

Muris, P., Otgaar, H., & Pfattheicher, S. (2019). Stripping the forest from the rotten trees: compassionate self-responding is a way of coping, but reduced uncompassionate self-responding mainly reflects psychopathology. *Mindfulness*, *10*(1), 196-199.


# Original Computing Environment {-}

```{r}
sessionInfo()
```

<!--chapter:end:100_thesis_ordlandi.Rmd-->

---
title: "Self-compassion, post-traumatic growth, and PTSD"
author: "[Corrado Caudek](https://ccaudek.github.io/)"
date: "Last modified `r format(Sys.time(), '%Y-%m-%d')`"
fontsize: 11pt
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

```{r, echo=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  strip.white = TRUE
)

suppressPackageStartupMessages(library("here"))
suppressPackageStartupMessages(library("lavaan"))
suppressPackageStartupMessages(library("brms"))
suppressPackageStartupMessages(library("tidyverse"))
library("ggthemes")
suppressPackageStartupMessages(library("viridis"))
library("tidyr")
suppressPackageStartupMessages(library("mice"))
suppressPackageStartupMessages(library("corrplot"))
suppressPackageStartupMessages(library("bayesplot"))
suppressPackageStartupMessages(library("semPlot"))
suppressPackageStartupMessages(library("rio"))
suppressPackageStartupMessages(library("outForest"))
suppressPackageStartupMessages(library("semTools"))
suppressPackageStartupMessages(library("semoutput"))
suppressPackageStartupMessages(library("isotree"))
suppressPackageStartupMessages(library("tidySEM"))
suppressPackageStartupMessages(library("stringr"))
suppressPackageStartupMessages(library("papaja"))

options(max.print = 99999999)

source(here("libraries", "self_compassion_fnc.R"))
```


# Motivation

Self-compassion (SC) has been proposed as a protective factor against PTSD and a factor promoting PTG.

One limit of these studies, however, is that they have often been performed in student populations, that is, in samples in which, supposedly, PTSD and PTG are only present in mild forms, if ever.

Moreover, in recent years, the role of SC has been questioned. For example, Muris, Otgaar and Pfattheicher (2019) maintain that SC is strongly associated with (reversed) Negative Affect and that, once the negative component of SC is removed, the added value of positive SC is marginal.

Furthermore, Geiger, Pfattheicher, Hartung, Weiss, Schindler, and Wilhelm (2018) have  questioned the fact that SC is a construct that does not overlap with Neuroticism. Once Neuroticism is controlled, there is no evidence of a specific contribution of SC.

The purpose of the present study is to evaluate the hypotheses of Muris et al. (2019) and of Geiger et al. (2018) in a sample of rescue workers.


# Prelims 

```{r}
temp <- readRDS(here("data", "processed", "rescue_workers_cleaned_data.rds"))
clean_dat <- temp %>% 
  dplyr::filter(age_imp > 20)
```


```{r, echo=FALSE}
# Save subjects ids
subjects <- data.frame(id = clean_dat$id)
saveRDS(subjects, here("data", "processed", "participants.Rds"))
```


```{r}
psych::describe(clean_dat)
```


Because of kurtosis for a sub-scale of PTG, robust estimation procedure with the Satorra-Bentler corrections were used. 


# Model 0 

M0 considers two endogenous variables: post-traumatic growth (ptgr) and post-traumatic stress (ptss) and their relations with 4 exogenous variables: coping (cope), perceived social support (soc), self-compassion (sc), and neuroticism (neuro). In model M0, only the regression effects of cope and soc are considered. M0 is therefore a baseline model.

I have included the other exogenous variables, also without considering their effects on the endogenous variables, in order to be able to compare different nested models, to test several theoretical questions.


```{r}
model0 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
          personal_strength + spirituality_changes + 
          interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ social_support + avoiding_strategies + 
          positive_attitude + problem_orientation + 
          transcendent_orientation
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc  
  ptss ~ cope + soc 

  self_judgment ~~ self_kindness
  "
```



```{r}
fit0 <- lavaan::sem(
  model0,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r, echo=FALSE}
fitMeasures(
  fit0, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```


```{r}
lavaan::standardizedSolution(fit0) %>% 
  mutate_if("is.numeric","round",3) %>% 
  filter(op == "=~")
```


# Model 1 

M1 considers, beyond the regression effects of M0, also an effect of self-compassion, but without distinguishing the two components of self-compassion.
Modification indices suggest to add a residual correlation between self_judgment and self_kindness.

```{r}
model1 <- "
  # measurement model
  
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
          personal_strength + spirituality_changes + 
          interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ social_support + avoiding_strategies + 
          positive_attitude + problem_orientation + 
          transcendent_orientation
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc + sc 
  ptss ~ cope + soc + sc 

  self_judgment ~~ self_kindness
  "
```


```{r}
fit1 <- lavaan::sem(
  model1,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
anova(fit1, fit0)
```

Model M1 improves the fit respect model M0. But the fit of M1 is still inadequate.


```{r, echo=FALSE}
fitMeasures(
  fit1, 
  c("cfi", "cfi.robust", "tli", "tli.robust", "rmsea", "srmr")
)
```


```{r, eval=FALSE, echo=FALSE}
semPaths(
  fit1, 
  "std",
  edge.label.cex = 0.75, 
  curvePivot = TRUE, 
  title = TRUE,
  fade = FALSE
)
```


# Model 1a 

M1a is an attempt of improving the fit of M1 by considering only a subset of dimensions of coping, because Coping was poorly defined by such indicators.

```{r}
model1a <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  sc ~~ neuro
  soc ~~ cope
  soc ~~ sc
  soc ~~ neuro
  cope ~~ sc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + sc 
  ptss ~ cope + soc + sc 
  
  self_judgment ~~ self_kindness
"
```


```{r}
fit1a <- lavaan::sem(
  model1a,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r, echo=FALSE}
fitMeasures(
  fit1a, 
  c("cfi", "cfi.robust", "tli", "tli.robust", "rmsea", "srmr")
)
```


```{r}
anova(fit1, fit1a)
```


# Model 2 

M2 distinguishes between the two components of self-compassion.

```{r}
model2 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   # + transcendent_orientation + avoiding_strategies + social_support 
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + nsc + psc 
  ptss ~ cope + soc + nsc + psc 

  self_judgment ~~ self_kindness
"
```


```{r}
fit2 <- sem(
  model2,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r, echo=FALSE}
fitMeasures(
  fit2, 
  c("cfi", "cfi.robust", "tli", "tli.robust", "rmsea", "srmr")
)
```

The fit improves.

```{r}
anova(fit1a, fit2)
```

```{r}
compareFit(fit2, fit1a, nested = TRUE)
```


# Model 6 

Model M6 adds the regression coefficient for Neuroticism.

```{r}
model6 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  psc =~ self_kindness + common_humanity + mindfulness
  nsc =~ self_judgment + isolation + over_identification
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptss ~ cope + soc + nsc + psc + neuro
  ptgr ~ cope + soc + nsc + psc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit6 <- sem(
  model6,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
anova(fit2, fit6)
```

The fit improves and is very good.

```{r, echo=FALSE}
fitMeasures(
  fit6, 
  c("cfi", "cfi.robust", "tli", "tli.robust", "rmsea", "srmr")
)
```

```{r}
summary(
  fit6,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```



```{r}
semPaths(
  fit6, 
  "std",
  edge.label.cex = 0.75, 
  curvePivot = TRUE, 
  title = TRUE,
  fade = FALSE
)
```



```{r}
lavaan::standardizedSolution(fit6) %>% 
  dplyr::filter(!is.na(pvalue)) %>% 
  arrange(desc(pvalue)) %>% 
  mutate_if("is.numeric","round",3) %>% 
  select(-ci.lower,-ci.upper,-z)

pvalue_cutoff <- 0.05

obj <- semPlot:::semPlotModel(fit6)

# save a copy of the original, so we can compare it later and 
#  be sure we removed only what we intended to remove
original_Pars <- obj@Pars

check_Pars <- obj@Pars %>% 
  dplyr::filter(!(edge %in% c("int","<->") | lhs == rhs)) 
# this is the list of paramater to sift thru

keep_Pars <- obj@Pars %>% 
  dplyr::filter(edge %in% c("int","<->") | lhs == rhs) 
# this is the list of paramater to keep asis

test_against <- lavaan::standardizedSolution(fit6) %>% 
  dplyr::filter(
    pvalue < pvalue_cutoff, rhs != lhs)

test_against_rev <- test_against %>% 
  rename(rhs2 = lhs,
         lhs = rhs) %>% 
  rename(rhs = rhs2)
# for some reason, the rhs and lhs are reversed in the 
# standardizedSolution() output, for some of the values

checked_Pars <-
    check_Pars %>% 
  semi_join(test_against, by = c("lhs", "rhs")) %>% 
  bind_rows(
        check_Pars %>% 
          semi_join(test_against_rev, by = c("lhs", "rhs"))
    )

# I'll have to reverse it myself, and test against both orders
obj@Pars <- keep_Pars %>% 
  bind_rows(checked_Pars)

#let's verify by looking at the list of the edges we removed from the object
anti_join(original_Pars, obj@Pars)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
semPaths(
  obj, 
  "col",
  "std", 
  rotation = 1,
  groups = "latents", 
  pastel = TRUE,
  residuals = FALSE,
  structural = TRUE,
  curvature = 5,
  edge.width = 2,
edge.label.cex = 1.3,
  mar = c(4, 1, 14, 1)
)
```


```{r, eval=FALSE, echo=FALSE}
semPaths(
  fit6, 
  "col",
  "std", 
  rotation = 1,
  groups = "latents", 
  pastel = TRUE,
  residuals = FALSE,
  structural = TRUE,
  curvature = 5,
  edge.width = 2,
  mar = c(3, 1, 12, 1)
)
```

```{r}
standardizedSolution(fit6) %>% 
  dplyr::filter(op == "~" & (lhs == "ptss" | lhs == "ptgr")) %>% 
  select(lhs, rhs, est.std, pvalue)
```


```{r, eval=FALSE, echo=FALSE}
# vlabs <- c(" x1 " = " Vis 1" , " x2 " = " Vis 2" , x3 = " Vis 3" , x4 = " Txt
# 1" , x5 = " Txt 2" , x6 = " Txt 3" , x7 = " Speed 1" , x8 = " Speed 2" ,
# x9 = " Speed 3")
# 
# fit1.t3 <- semTable (
#   fit6, 
#   columns = c(" est " , " se " , "p") , 
#   paramSets = c(" loadings ") , 
#   fits = c(" chisq " , " rmsea ") , 
#   file = file.path ( tempdir , " fit1.t3 ") , 
#   varLabels = vlabs , 
#   longtable = FALSE , 
#   table.float = TRUE , 
#   caption = " Table Floated ( not a longtable )" , 
#   label = "tab : fit1.t3 ")
```


```{r}
graph_sem(model = fit10)
```


# Model 7 

Model 7 remove the two self-compassion regression effects from M6.

```{r}
model7 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptss
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # regressions
  ptgr ~ cope + soc + neuro
  ptss ~ cope + soc + neuro
  
# covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit7 <- sem(
  model7,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
anova(fit6, fit7)
```

M6 provides a better fit.

```{r, echo=FALSE}
fitMeasures(
  fit7, 
  c("cfi", "cfi.robust", "tli", "tli.robust", "rmsea", "srmr")
)
```


# Model 8 

M8 remove only the regression effect of the negative component of self-compassion from M6.

```{r}
model8 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + psc + neuro
  ptss ~ cope + soc + psc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```

```{r}
fit8 <- sem(
  model8,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

The goodness of fit decreases.

```{r}
anova(fit6, fit8)
```


```{r, echo=FALSE}
fitMeasures(
  fit8, 
  c("cfi", "cfi.robust", "tli", "tli.robust", "rmsea", "srmr")
)
```


# Model 9 

M9 removes only the positive component of self-compassion from M6.

```{r}
model9 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + nsc + neuro
  ptss ~ cope + soc + nsc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit9 <- sem(
  model9,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

The goodness of fit decreases.

```{r}
anova(fit6, fit9)
```


# Model 10

M10: a mediation structure with the two components of self-compassion

```{r}
model10 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ dg_cope*cope + dg_soc*soc + dg_neuro*neuro
  ptss ~ ds_cope*cope + ds_soc*soc + ds_neuro*neuro

  nsc ~ nsc_cope*cope + nsc_soc*soc + nsc_neuro*neuro
  psc ~ psc_cope*cope + psc_soc*soc + psc_neuro*neuro
  
  ptgr ~ ig_nsc*nsc + ig_psc*psc 
  ptss ~ is_nsc*nsc + is_psc*psc
  
  # covariances
  self_judgment ~~ self_kindness
  
  # indirect and total effects
  # cope
  i_cope_s := nsc_cope * is_nsc + psc_cope * is_psc
  i_cope_g := nsc_cope * ig_nsc + psc_cope * ig_psc
  tot_cope_s := i_cope_s + ds_cope
  tot_cope_g := i_cope_g + dg_cope
  tot_cope := i_cope_s + i_cope_g

  # soc
  i_soc_s := nsc_soc * is_nsc + psc_soc * is_psc
  i_soc_g := nsc_soc * ig_nsc + psc_soc * ig_psc
  tot_soc_s := i_soc_s + ds_soc
  tot_soc_g := i_soc_g + dg_soc
  tot_soc := i_soc_s + i_soc_g
  
  # neuro
  i_neuro_s := nsc_neuro * is_nsc + psc_neuro * is_psc
  i_neuro_g := nsc_neuro * ig_nsc + psc_neuro * ig_psc
  tot_neuro_s := i_neuro_s + ds_neuro
  tot_neuro_g := i_neuro_g + dg_neuro
  tot_neuro := i_neuro_s + i_neuro_g
"
```


```{r}
fit10 <- sem(
  model10,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```

```{r}
fit10_boot <- sem(
  model10,
  data = clean_dat,
  estimator = "ML",
  std.lv = TRUE,
  se = "bootstrap", 
  bootstrap = 10000
)
```



```{r}
parameterestimates(
  fit10_boot, 
  boot.ci.type = "bca.simple", 
  standardized = TRUE) 
```

```{r}
boot_mediation <- parameterEstimates(
  fit10_boot, se = TRUE, zstat = TRUE, pvalue = TRUE, 
                    ci = TRUE, level = 0.95, boot.ci.type = "perc", 
                    standardized = TRUE, remove.system.eq = TRUE,
                    remove.eq = TRUE, remove.ineq = TRUE, remove.def = FALSE, 
                    rsquare = TRUE
  ) %>% 
  dplyr::filter(op == ":=")
boot_mediation
saveRDS(boot_mediation, "boot_mediation.Rds")
```

```{r}
boot_mediation <- readRDS("boot_mediation.Rds")
```

```{r}
foo <- boot_mediation[-c(5, 10, 15), c(1, 5, 6, 9:10)] 

now_names <- c(
   "Ind. eff. coping -> PTSS", 
   "Ind. eff. coping -> PTG", 
   "Tot. eff. coping -> PTSS", 
   "Tot. eff. coping -> PTG", 
   "Ind. eff. soc. supp. -> PTSS",   
   "Ind. eff. soc. supp. -> PTG", 
   "Tot. eff. soc. supp. -> PTSS", 
   "Tot. eff. soc. supp. -> PTG", 
   "Ind. eff. neuro. -> PTSS", 
   "Ind. eff. neuro. -> PTG",  
   "Tot. eff. neuro. -> PTSS", 
   "Tot. eff. neuro. -> PTG"
)

foo$lhs <- now_names

foo %>% 
  knitr::kable(
    col.names = c("Effect", "Estimate", "S.E.", "C.I. lower", "C.I. upper"),
    digits = 3,
    row.names = FALSE
  )
```



```{r}
summary(
  fit10,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```


```{r}
lavaan::standardizedSolution(fit10) %>% 
  dplyr::filter(!is.na(pvalue)) %>% 
  arrange(desc(pvalue)) %>% 
  mutate_if("is.numeric","round",3) %>% 
  select(-ci.lower,-ci.upper,-z)

pvalue_cutoff <- 0.05

obj <- semPlot:::semPlotModel(fit10)

# save a copy of the original, so we can compare it later and 
#  be sure we removed only what we intended to remove
original_Pars <- obj@Pars

check_Pars <- obj@Pars %>% 
  dplyr::filter(!(edge %in% c("int","<->") | lhs == rhs)) 
# this is the list of paramater to sift thru

keep_Pars <- obj@Pars %>% 
  dplyr::filter(edge %in% c("int","<->") | lhs == rhs) 
# this is the list of paramater to keep asis

test_against <- lavaan::standardizedSolution(fit10) %>% 
  dplyr::filter(
    pvalue < pvalue_cutoff, rhs != lhs)

test_against_rev <- test_against %>% 
  rename(rhs2 = lhs,
         lhs = rhs) %>% 
  rename(rhs = rhs2)
# for some reason, the rhs and lhs are reversed in the 
# standardizedSolution() output, for some of the values

checked_Pars <-
    check_Pars %>% 
  semi_join(test_against, by = c("lhs", "rhs")) %>% 
  bind_rows(
        check_Pars %>% 
          semi_join(test_against_rev, by = c("lhs", "rhs"))
    )

# I'll have to reverse it myself, and test against both orders
obj@Pars <- keep_Pars %>% 
  bind_rows(checked_Pars)

#let's verify by looking at the list of the edges we removed from the object
anti_join(original_Pars, obj@Pars)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
semPaths(
  obj, 
  "col",
  "std", 
  rotation = 1,
  groups = "latents", 
  pastel = TRUE,
  residuals = FALSE,
  structural = TRUE,
  curvature = 5,
  edge.width = 2,
edge.label.cex = 1.3,
  mar = c(4, 1, 14, 1)
)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
semPaths(
  obj, 
  "col",
  "std", 
  rotation = 1,
  groups = "latents", 
  pastel = TRUE,
  residuals = FALSE,
  structural = TRUE,
  curvature = 5,
  edge.width = 2,
  edge.label.cex = 1.3,
  mar = c(4, 1, 14, 1)
)
```

```{r}
std_solution <- lavaan::standardizedSolution(fit10) %>% 
  mutate_if("is.numeric","round",3) %>% 
  filter(op == "~" | op == "~~")
```


```{r}
lay <- get_layout(
  "cope", "soc",  "neuro",
  "nsc", "", "psc",
  "ptss", "", "ptgr", 
  rows = 3)
lay
```

```{r}
graph_sem(fit10, layout = lay)
```

```{r}
graph_data <- prepare_graph(model = fit10, layout = lay)
tidySEM::nodes(graph_data)
```

```{r}
graph_data[[1]]$label[c(2, 7, 9, 10, 12, 14, 15, 24:27)] <- 
  std_solution[c(2, 7, 9, 10, 12, 14, 15, 24:27), 4]
```


```{r}
tidySEM::edges(graph_data)
```

```{r}
tidySEM::nodes(graph_data) <- tidySEM::nodes(graph_data) %>%
  mutate(label = str_to_title(label))
```

```{r}
tidySEM::edges(graph_data) %>%
  mutate(connect_from = replace(connect_from, is.na(curvature), "bottom")) %>%
  mutate(connect_to = replace(connect_to, is.na(curvature), "top")) -> tidySEM::edges(graph_data)
```

```{r}
plot(graph_data)
```

```{r}
graph_sem(model = fit10, layout = lay, angle = 90)
```

```{r}
edges(graph_data)
plot(graph_data)
```

```{r}
chars <- "test"
value <- "es"
str_detect(chars, value)
```


```{r}
lay <- get_layout(
  "", "cope", "soc",  "neuro", "",
  "nsc", "", "", "", "psc",
  "", "ptss", "", "ptgr", "",
  rows = 3)

graph_data <- prepare_graph(model = fit10, layout = lay)
foo <- edges(graph_data) 
foo1 <- foo[c(2, 7, 9:10, 12, 14, 15, 25:27), ]

graph_data$edges <- foo1


plot(graph_data)
```








# Mediation model without distinguishing between positive and negative components of self-compassion.


M10 hypothesizes a mediation structure

```{r}
model11 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ dg_cope*cope + dg_soc*soc + dg_neuro*neuro
  ptss ~ ds_cope*cope + ds_soc*soc + ds_neuro*neuro

  sc ~ sc_cope*cope + sc_soc*soc + sc_neuro*neuro

  ptgr ~ ig_nsc*sc  
  ptss ~ is_nsc*sc 
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit11 <- sem(
  model11,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)
```


```{r}
summary(
  fit11,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```


```{r}
anova(fit11, fit10)
```

# Mediation model with 2 components of SC and neuroticism as mediators

```{r}
model12 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ dg_cope*cope + dg_soc*soc 
  ptss ~ ds_cope*cope + ds_soc*soc 

  nsc ~ nsc_cope*cope + nsc_soc*soc 
  psc ~ psc_cope*cope + psc_soc*soc 
  neuro ~ n_cope*cope + n_soc*soc
  
  ptgr ~ ig_nsc*nsc + ig_psc*psc + ig_neuro*neuro
  ptss ~ is_nsc*nsc + is_psc*psc + is_neuro*neuro
  
  # covariances
  self_judgment ~~ self_kindness
"
```


```{r}
fit12 <- sem(
  model12,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE,
  optim.dx.tol = TRUE
)
```

```{r}
summary(
  fit12,
  standardized = TRUE,
  fit.measures = TRUE,
  rsquare = TRUE
)
```


```{r}
anova(fit12, fit10)
```

mi <- modindices(fit12)
mi[mi$op == "=~",]







```{r}
d <- clean_dat %>% dplyr::select(where(is.numeric))
R <- cor(d)
```


```{r}

fit10a <- sem(
  model10,
  sample.cov = R,
  sample.nobs = 731,
  std.lv = TRUE
)
```

```{r}
lay <- get_layout(
  "", "cope", "soc",  "neuro", "",
  "nsc", "", "", "", "psc",
  "", "ptss", "", "ptgr", "",
  rows = 3)

graph_data <- prepare_graph(model = fit10a, layout = lay)
plot(graph_data)
```







```{r}
edges(graph_data) %>%
  mutate(colour = "black") %>%
  mutate(colour = replace(colour, from == "visual" & to == "x2", "red")) %>%
  mutate(linetype = 1) %>%
  mutate(linetype = replace(linetype, from == "visual" & to == "x2", 2)) %>%
  mutate(alpha = 1) %>%
  mutate(alpha = replace(alpha, from == "visual" & to == "x2", .5)) -> edges(graph_data)

```


<!--chapter:end:60_self_compassion_sem.Rmd-->



Some general data properties, which are needed to determine the most appropriate analytical approach, were examined. The absence of multivariate normality in all items (Mardia's Test: sig. < .01), and missing data (11.3% of the cases, with a completely random distribu- tion of the missing data; Little's test sig. p > .05) were observed. Given the ordinal nature of the data, the weighted least square with adjusted mean and variance (WLSMV) (Beauducel & Herzberg, 2006; Rhemtulla et al., 2012) approach was used as an estimation method of the factor models.

In all studied models, goodness of fit was determined by using the comparative fit index (CFI), the Tucker- Lewis index (TLI) and the root mean square of approxi- mation (RMSEA). For the CFI and TLI, values above .90 and .95, respectively, indicate an acceptable and adequate fit (Chen, 2007, Hu & Bentler, 1999). In the case of the RMSEA, values below .08 and .05, respectively, indicate an acceptable and appropriate fit (Cheung & Rensvold, 2002). To determine the significance of the fit differences between the nested or equivalent models, Chen (Chen, 2007) and Cheung and Resvold's (Cheung & Rensvold, 2002) recommendations were followed. According to these scholars, increases in the CFI and TLI less than .01 and decreases in the RMSEA less than .015 suggest that there are no substantial differences in fit among the com- pared models. All analyses were performed by using MPlus v 7.3 (Muthén & Muthén, 2014).

The following data analytic strategy was adopted. First, six measurement models were estimated via ICM-CFA (independent clusters model of confirmatory factor analysis). Second, and based on the results from the previous step, an ESEM model with a similar configuration to the four-correlated-factor structure proposed by the DSM–5 was estimated. Third, an ESEM bifactor model was estimated to explore the existence of a common source of variance to all PTSD symptoms. To estimate the model-based reliability for each factor the omega index was calculated in the case of the first order models (McDonald, 1999). The omega hierarchical index (Zinbarg et al., 2006) and the omega sub-scale were estimated in the case of the bifactor model (Reise, 2012). These indexes quantify the degree to which the factor scores accurately reflect the position of the subject in the latent variable (values above .70 are required to ensure the psychometric interpretability of the factor). To estimate the internal consistency of each factor, Cronbach's alpha was used.






```{r fig.cap="Boxplots of mean response times for all fast tasks, split by age groups. See Table 1 for an explanation of the task names.", warning=FALSE, fig.height=3}
# Figure A1
# Boxplots mean RT for fast tasks

temp <- readRDS(here("data", "processed", "rescue_workers_cleaned_data.rds"))
clean_dat <- temp %>% 
  dplyr::filter(age_imp > 20)

clean_dat %>% 
  ggplot(aes(gender, years_experience))+
    geom_boxplot() + 
  labs(x="", y="Mean RT in ms") + 
  facet_wrap(vars(where)) + 
  theme_apa() 
```


<!--chapter:end:appendix.Rmd-->

---
title             : "Effects of self-compassion on post-traumatic growth and PTSD"
shorttitle        : "Construct validity of SCS"
author:
  - name          : "Corrado Caudek"
    affiliation   : "1"
    corresponding : yes
    address       : "NEUROFARBA Department, Psychology Section, University of Firenze, Italy"
    email         : "ccaudek@unifi.it"
  - name          : "Celeste Berti"
    affiliation   : "1"
  - name          : "Claudio Sica"
    affiliation   : "2"
  - name          : "Ilaria Colpizzi"
    affiliation   : "1"
affiliation:
  - id            : "1"
    institution   : "NEUROFARBA Department, Psychology Section, University of Florence, Italy"
  - id            : "2"
    institution   : "Health Sciences Department, Psychology Section, University of Florence, Italy"
authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.
  Enter author note here.
abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  
  Two to three sentences of **more detailed background**, comprehensible  to scientists in related disciplines.
  
  One sentence clearly stating the **general problem** being addressed by  this particular study.
  
  One sentence summarizing the main result (with the words "**here we show**" or their equivalent).
  
  Two or three sentences explaining what the **main result** reveals in direct comparison to what was thought to be the case previously, or how the  main result adds to previous knowledge.
  
  One or two sentences to put the results into a more **general context**.
  
  Two or three sentences to provide a **broader perspective**, readily comprehensible to a scientist in any discipline.
  
  
  <!-- https://tinyurl.com/ybremelq -->
keywords          : "keywords"
wordcount         : "`r wordcountaddin::word_count()`"
bibliography      : ["self-compassion.bib"]
floatsintext      : yes
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no
csl               : "apa7.csl"
documentclass     : "apa7"
classoption       : "man"
output            : 
  papaja::apa6_pdf:
    includes:
      after_body: "appendix.tex"
    latex_engine: "xelatex"
    extra_dependencies: ["xcolor"]
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: sentence
header-includes:
  - \usepackage{rotating}
  - \DeclareDelayedFloatFlavor{sidewaysfigure}{figure}  
  - \DeclareDelayedFloatFlavor{sidewaystable}{table}
  - \usepackage{pdflscape}                                
  - \DeclareDelayedFloatFlavor{landscape}{table}   
  - \raggedbottom 
  - \usepackage{xcolor,makecell,array}
  - \usepackage{graphicx}
  - \usepackage{placeins}
  - \setlength{\parskip}{0pt plus 0pt minus 0pt}
  - \usepackage{multirow}
  - \usepackage{setspace}
  - \usepackage{booktabs}
  - \usepackage{tabularx}
  - \usepackage{caption}
  - \usepackage{color, colortbl}
---

```{r setup, include = FALSE}
library(pacman)
p_load(tidyverse, papaja, psych, scales, lavaan, gridExtra, install = FALSE) 
r_refs("r-references.bib")
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

```{r}
# -- R code --
suppressPackageStartupMessages(library("here"))
suppressPackageStartupMessages(library("lavaan"))
suppressPackageStartupMessages(library("brms"))
suppressPackageStartupMessages(library("tidyverse"))
library("ggthemes")
suppressPackageStartupMessages(library("viridis"))
library("tidyr")
suppressPackageStartupMessages(library("mice"))
suppressPackageStartupMessages(library("corrplot"))
suppressPackageStartupMessages(library("bayesplot"))
suppressPackageStartupMessages(library("semPlot"))
suppressPackageStartupMessages(library("rio"))
suppressPackageStartupMessages(library("outForest"))
suppressPackageStartupMessages(library("semTools"))
suppressPackageStartupMessages(library("semoutput"))
suppressPackageStartupMessages(library("isotree"))
suppressPackageStartupMessages(library("tidySEM"))
suppressPackageStartupMessages(library("nonnest2"))
suppressPackageStartupMessages(library("papaja"))

source(here("libraries", "self_compassion_fnc.R"))
```

```{r}
temp <- readRDS(here("data", "processed", "rescue_workers_cleaned_data.rds"))
clean_dat <- temp %>% 
  dplyr::filter(age_imp > 20)
```

# Introduction

Self-compassion is a construct derived from the Buddhist tradition and has been conceptualized by @neff2003development as motivation to adopt a compassionate mindset towards themselves in order to prevent suffering of self and others.
Self-compassion (SC) has been proposed as a protective factor against psychopathology, including PTSD, and as a factor promoting PTG (ref).

The SC construct is typically assessed with the Self-Compassion Scale (SCS), a 26 item self-report scale [@neff2003development].
The SCS items span six dimensions of the construct.
Three sub-sets of items are indicators of compassionate self-responding: (a) being kind and understanding toward one's fallibility, (b) acknowledging that personal failures and pain are something that everyone experiences, and (c) having a mindful awareness of one's painful thoughts and feelings.
The remaining three sub-sets of items are indicators of the negation of uncompassionate self-responding: (a) being critical and not understanding toward personal shortcomings, (b) having the tendency of isolating from others, and (c) avoiding one's painful thoughts and feelings or overidentifying with them.
The SCS total score is given by the sum of the self-responding on the compassionate items and the reversely scored uncompassionate items.

The construct of SC and the SCS has been extremely popular in the recent psychological literature [for a recent review, see @muris2020process].
A measure of such success is provided, for example, by a search of the literature conducted on December 18, 2020 using "self compassion" in Topic as a search term, which yielded 2,380 results.
However, the growing success of the SCS has not been unchallenged and questions have been raised about the validity of this scale [@muris2016protective; @muris2016protection; @muris2017protection; @muris2019stripping; @kandler2017old].

@muris2020process, for example, has pointed to the fact that the common practice of considering the construct measured by the SCS as a unitary construct is problematic:

> We argue that this criticism is far from trivial and seriously undermines the scientific foundation of the self-compassion concept (p. 1473).

In several papers, Muris and collaborators have pointed out the fact that researchers tend to treat the SC construct as a "pure protective factor", rather than to present a more nuanced picture of SC [e.g., @gu2020development; @montero2018self; @seppala2017oxford; @strauss2016compassion] and, as a consequence of this, the data of the SCS are usually summarized in terms of the SCS total score.
But the use of the total score is problematic for several reasons.
For the present purposes, it is important to focus on the following two criticisms.

1.  The use of the SCS total score tend to inflate the link with psychopathology. According to @muris2018good, in fact, the relations that have been found between the SCS total scores and other psychological constructs mainly depend on the uncompassionate component of the SCS. But the uncompassionate component of the SCS is strongly associated with (reversed) Negative Affect and, once the negative component of SC is removed, the added value of positive SC is marginal.

<!-- 1. The use of the SCS total score tend to inflate the link with psychopathology, given that the uncompassionate features of the SCS closely resemble psychopathological symptoms.  According to @muris2018good, the relations that have been found between the SCS total scores and other psychological constructs mainly depend on the uncompassionate component of the SCS. If this is true, then it would be legitimate to conclude that the SC construct is redundant, because the uncompassionate component of the SCS is strongly associated with (reversed) Negative Affect and, once the negative component of SC is removed, the added value of positive SC is marginal. -->

2.  It is not clear what, if anything, is added by the compassionate component of the SCS to the nomological network in which SC is situated. @kandler2017old have taken the extreme stance of arguing that the SC construct is redundant because it overlaps with with the personality trait of Neuroticism: Once Neuroticism is controlled, there is no evidence of a specific contribution of SC.

This debate has receiving considerable attention in the recent literature on SC, because the questions that have been raised are relevant for therapeutic interventions.
In fact, it is of interest to understand whether the association between the treatment effects and the compassionate component of SC may be obscured by the common use of the SCS total score [@wadsworth2018examining].

In summary, the criticisms that have been directed towards the use of the SCS total score as a proxy for the SC construct point to the necessity of (1) distinguishing the compassionate self-responding from the uncompassionate component of the SCS, (2) evaluating the relative contribution of each of these two components, and (3) establishing whether the the compassionate self-responding has incremental value above and beyond other psychological factors currently examined in therapeutic settings, in primis the personality trait of Neuroticism.

------------------------------------------------------------------------

As a consequence, it has been asked whether the construct of SC (as measured by the SCS) is useful (in that it adds something new) or whether it is redundant, as it can be replaced with the personality trait of neuroticism [@kandler2017old].
Specifically, given that the total score of the SCS is given by the sum of the indicators of the compassionate and uncompassionate components of the SCS, the question has been raised about the relative contribution of the compassionate components of SC to the total score.

One limit of these studies, however, is that they have often been performed in student populations, that is, in samples in which, supposedly, PTSD and PTG are only present in mild forms.
The purpose of the present study is to evaluate the hypotheses of @muris2019stripping and of @geiger2018self in a sample of rescue workers.

Rescue workers are a population at risk for high levels of burnout and compassion fatigue.
???

Questions:

-   **HP1**: Is the construct of self-compassion (SC) necessary?
    It has been proposed that the effects of self-compassion can be due only to the negative component of SC, whereas the positive component of SC has no effect.
    If this were true, then there would be no need of the construct of SC, given that the negative component of SC reduces to negative affect (ref).
    To answer this question is necessary to show that the positive component of SC has an effect on other psychological constructs, beyond that of the negative component of SC.

-   **HP2**: It has been argued that SC reduces to nevroticism.
    Again, it this were true, then we would not need the separate construct of SC.
    In order to test this hypothesis (ref) it would be necessary to show that both components of SC provide an added value in a nomological network which includes the construct of nevroticism.

In the present study we tested these two hypotheses by comparing different SEM models including the folloging constructs...

PTSS and PTG emerge only in individuals subjected to high load of psychological stress.
For this reason, we examined a large sample of rescue workers.

# Methods

<!-- We report how we determined our sample size, all data exclusions (if any), all manipulations, and all measures in the study. <!-- 21-word solution (Simmons, Nelson & Simonsohn, 2012; retrieved from http://ssrn.com/abstract=2160588) -->

## Participants

## Material

Specific questions for ambulance personnel were developed to investigate the role that the respondent usually covered (such as driver, team leader, rescuer, etc.), number of weekly shifts, and number of psychological support meeting (such as debriefing and defusing) every participants have requested during the last two weeks and their careers (e.g. "How often are you on ambulance duty?", and "Do you usually take shift with the same team?").
Moreover, the researchers asked participants to tell about a traumatic event occurs during their careers, which they felt seriously affected by (e.g. "Would you mind to briefly describe a traumatic event you have experienced during your career?").

Personality traits were assessed using the *NEO-Five Factor Inventory* (NEO-FFI-60; Costa & McCrae, 1992; Italian version by Caprara et al., 2001), based upon the Five Factors Model (FFM) of personality traits (McCrae & Costa, 1987).
The NEO-FFI-60 is a 60 items self-report questionnaire that allows the assessment of five broad personality domains: Neuroticism (N), Extraversion (E), Openness to Experience (O), Agreeableness (A), and Conscientiousness (C).
The respondent is asked to rate the items on 5-point Likert scale ranging from 0 (Strongly disagree) to 4 (Strongly agree).
NEO-FFI showed good internal consistency, Cronbach's alpha ranging from .68 (A) to .89 (N).

The coping strategies were investigated using the Italian version of the *Coping Orientation to Problem Experienced Inventory* (COPE, Carver et al., 1989; Sica et al., 2008).
COPE is a self-report questionnaire composed by 60 items used to assess a wide range of coping strategies gathered in 15 scales: 1) active coping, 2) planning, 3) seeking instrumental social support, 4) seeking emotional social support, 5) suppression of competing activities, 6) turning to religion, 7) positive reinterpretation and growth, 8) restraint coping, 9) acceptance, 10) focus on and venting of emotions, 11) denial, 12) mental disengagement, 13) behavioral disengagement, 14) alcohol/drug use, and 15) humor.
The scales were grouped in the following dimension: Problem focused, Avoidant coping, Social support, Emotion focused and Religion.
The items are rated on a 4-point Likert scale ranging from 1 (I don't usually do that) to 4 (I usually do that).
Internal consistency (Chronbach's $\alpha$) ranging from $\alpha$ = .70 to $\alpha$ = .91.

The *Post-Traumatic Growth Inventory* (PTGI; Tedeschi & Calhoun, 1996; Italian version by Prati & Pietrantoni, 2006) is a 21 item self-report measure.
PTGI evaluates the growth following one or more stressful or traumatic events in one's life.
The item score ranging on a 7-point Likert scale, from 0 (No change) to 6 (Very important change).
The PTGI comprises five subscales: Relation with others, New possibilities, Personal strength, Appreciation of life, and Spiritual changes.
The Incident of Event Scale - revised (IES-R; Horowitz et al., 1979; Weiss & Marmar, 1997; Weiss, 2004) is widely used to assess the symptomatology of the Post-Traumatic Stress Disorder in rescue workers.
IES-R is used to investigate the three symptoms of PTSD: Intrusion, Hypervigilance, and Avoidance.
The score ranging on a 5-point Likert scale from 0 (Not at all) to 4 (Extremely).
Each subscale showed high internal consistency (Chronbach's $\alpha$), intrusion = 0.87 to 0.94, avoidance = 0.84 to 0.97, hyperarousal = 0.79 to 0.91.

Self-compassion was measured using the 26 items of the *Self-Compassion Scale* (SCS; Neff, 2003; Italian version by Veneziani et al., 2017).
This self-report questionnaire is composed by two subscales which are divided in three component themselves: Self-Kindness, Common Humanity, and Mindfulness identified the positive subscale, while Self-Judgement, Isolation, and Overidentification the negative subscale.
SCS score ranging on a 5-point Likert scale from 1 (Almost always) to 5 (Almost never).
High scores of self-compassion reflect an ability to be kind and understanding toward oneself, even in difficult times.
Internal consistency for unidimensional Self-Compassion was found of 0.92 (Neff, 2003a).

TODO: reliability of the SCS with the present sample

For the present sample, consistently with @neff2019examining, reliability was computed by examining a bi-factor model in which each loaded on its corresponding factor, but also on an overarching factor.

Multi-dimensional Scale of Perceived Social Support (MSPSS; Zimet et al., 1988; Italian version by Prezza & Pacilli, 2002) was used to assess how participants perceived social support.
MSPSS is a 12 items self-report questionnaire, and respondent was asked to rate their experience of perceived support from Family, Friends, and Significant Others.
MSPSS showed an internal consistency between 0.80 and 0.95 (Ozdemir, 2019).

## Procedure

## Data analysis

TODO

<!-- We used `r cite_r("r-references.bib")` for all our analyses. -->

# Results

## Preliminary Analysis and Descriptive Statistics

TODO

## Model Testing

Structural equation modeling (SEM; Arbuckle, 2010) was used to examine the current research hypotheses.
In order to assess the model fit, the following indices were used: $\chi^2$, $\chi^2$/df index, normed fit index (NFI), comparative fit index (CFI), Tucker--Lewis index (TLI), and root-mean-square error of approximation (RMSEA).
Model fit with NFI, CFI, and TLI was equal or greater than 0.90, RMSEA equal to or less than 0.08, and $\chi^2$/df index \< 4 are indicative of an adequate fit to the data (Hair et al., 2009; Awang, 2012).

```{r}
model0 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
          personal_strength + spirituality_changes + 
          interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ social_support + avoiding_strategies + 
          positive_attitude + problem_orientation + 
          transcendent_orientation
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc  
  ptss ~ cope + soc 

  self_judgment ~~ self_kindness
  "
```

```{r}
fit0 <- lavaan::sem(
  model0,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

fit_meas_m0 <- fitMeasures(
  fit0, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

A number of structural equation models were examined to determine which of the models provided the best fit to data.
The first SEM model (M0) comprised all the observed sub-scales loading on their respective six latent factors: self-compassion, coping, perceived social support, neuroticism, post-traumatic growth, and post-traumatic stress disorder.
The model M0 included direct paths between two exogenous variables (coping, perceived social support) and the two endogenous variables of interest (post-traumatic growth, and post-traumatic stress disorder).
It is, therefore, a baseline model.
Modification indices suggested the inclusion of a residual covariance between the subscales of Self judgment and Self kindness.
The M0 model showed an unacceptable fit with the data, $\chi^2$(`r fit_meas_m0[2]`) = `r fit_meas_m0[1]`, $\chi^2$/df = `r fit_meas_m0[1] / fit_meas_m0[2]`, CFI = `r fit_meas_m0[3]`, NFI = `r fit_meas_m0[5]`, TLI = `r fit_meas_m0[6]`, RMSEA = `r fit_meas_m0[8]`, and SRMS = `r fit_meas_m0[9]`.
Overall, the CFA fit indices did not support the model M0 which did not include a regression effect of either self-compassion or neuroticism (Hair et al., 2009; Jackson et al., 2009).

```{r}
model1 <- "
  # measurement model
  
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
          personal_strength + spirituality_changes + 
          interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ social_support + avoiding_strategies + 
          positive_attitude + problem_orientation + 
          transcendent_orientation
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  # regressions
  ptgr ~ cope + soc + sc 
  ptss ~ cope + soc + sc 

  self_judgment ~~ self_kindness
  "

fit1 <- lavaan::sem(
  model1,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

anova_m0m1 <- anova(fit1, fit0)

fit_meas_m1 <- fitMeasures(
  fit1, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

The second model (M1) added direct paths between self compassion and the endogenous variables, but without distinguishing the two components of self-compassion.
A comparison of the model M1 with the model M0 indicated that the model M1 did improve fit, $\Delta \chi^2$(`r anova_m0m1[2, 6]`) = `r round(anova_m0m1[2, 5], 2)`, $p =$ `r round(anova_m0m1[2, 7], 4)`, but still showed an unacceptable fit with the data, $\chi^2$(`r fit_meas_m1[2]`) = `r fit_meas_m1[1]`, $\chi^2$/df = `r fit_meas_m1[1] / fit_meas_m1[2]`, CFI = `r fit_meas_m1[3]`, NFI = `r fit_meas_m1[5]`, TLI = `r fit_meas_m1[6]`, RMSEA = `r fit_meas_m1[8]`, and SRMS = `r fit_meas_m1[9]`.

```{r}
model1a <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  sc ~~ neuro
  soc ~~ cope
  soc ~~ sc
  soc ~~ neuro
  cope ~~ sc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + sc 
  ptss ~ cope + soc + sc 
  
  self_judgment ~~ self_kindness
"

fit1a <- lavaan::sem(
  model1a,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

anova_m0m1a <- anova(fit1a, fit1)

fit_meas_m1a <- fitMeasures(
  fit1a, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

The third model (M1a) attempted of improving the fit of M1 by only considering a subset of dimensions of coping (Positive attitude and Problem orientation), because Coping was poorly defined by such indicators.
A comparison of the model M1a with the model M1 indicated that the model M1a did improve fit, $\Delta \chi^2$(`r anova_m0m1a[2, 6]`) = `r round(anova_m0m1a[2, 5], 2)`, $p =$ `r round(anova_m0m1a[2, 7], 4)`, but still showed an unacceptable fit with the data, $\chi^2$(`r fit_meas_m1a[2]`) = `r fit_meas_m1a[1]`, $\chi^2$/df = `r fit_meas_m1a[1] / fit_meas_m1a[2]`, CFI = `r fit_meas_m1a[3]`, NFI = `r fit_meas_m1a[5]`, TLI = `r fit_meas_m1a[6]`, RMSEA = `r fit_meas_m1a[8]`, and SRMS = `r fit_meas_m1a[9]`.

```{r}
model2 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   # + transcendent_orientation + avoiding_strategies + social_support 
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + nsc + psc 
  ptss ~ cope + soc + nsc + psc 

  self_judgment ~~ self_kindness
"

fit2 <- sem(
  model2,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

anova_m2m1a <- anova(fit2, fit1a)

fit_meas_m2 <- fitMeasures(
  fit2, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

The forth model (M2) improved on the structure of M1a by distinguishing between the two components of self-compassion: positive self-compassion and negative self-compassion.
A comparison of the model M2 with the model M1a indicated that the model M2 did improve fit, $\Delta \chi^2$(`r anova_m2m1a[2, 6]`) = `r round(anova_m2m1a[2, 5], 2)`, $p =$ `r round(anova_m2m1a[2, 7], 4)`.
The model M2 showed a good fit with the data, $\chi^2$(`r fit_meas_m2[2]`) = `r fit_meas_m2[1]`, $\chi^2$/df = `r fit_meas_m2[1] / fit_meas_m2[2]`, CFI = `r fit_meas_m2[3]`, NFI = `r fit_meas_m2[5]`, TLI = `r fit_meas_m2[6]`, RMSEA = `r fit_meas_m2[8]`, and SRMS = `r fit_meas_m2[9]`.

```{r}
model3 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
  
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 
   # + transcendent_orientation + avoiding_strategies + social_support 
  
  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach
  
  psc ~~ nsc
  psc ~~ neuro
  nsc ~~ neuro
  soc ~~ cope
  soc ~~ nsc
  soc ~~ psc
  soc ~~ neuro
  cope ~~ nsc
  cope ~~ psc
  cope ~~ neuro
  
  # regressions
  ptgr ~ cope + soc + nsc + psc + neuro
  ptss ~ cope + soc + nsc + psc + neuro

  self_judgment ~~ self_kindness
"

fit3 <- sem(
  model3,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

anova_m3m2 <- anova(fit3, fit2)

fit_meas_m3 <- fitMeasures(
  fit3, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

```{r semplot, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Direct effects of self-compassion to post-traumatic growth (`ptg`) and PTST (`pts`). `cop` = coping, `soc` = perceived social support, `nsc` = negative self compassion, `psc` = positive self compassion, `ner` = nevroticism."}
# lavaan::standardizedSolution(fit3) %>% 
#   dplyr::filter(!is.na(pvalue)) %>% 
#   arrange(desc(pvalue)) %>% 
#   mutate_if("is.numeric","round",3) %>% 
#   select(-ci.lower,-ci.upper,-z)

pvalue_cutoff <- 0.05

obj <- semPlot:::semPlotModel(fit3)

# save a copy of the original, so we can compare it later and 
#  be sure we removed only what we intended to remove
original_Pars <- obj@Pars

check_Pars <- obj@Pars %>% 
  dplyr::filter(!(edge %in% c("int","<->") | lhs == rhs)) 
# this is the list of paramater to sift thru

keep_Pars <- obj@Pars %>% 
  dplyr::filter(edge %in% c("int","<->") | lhs == rhs) 
# this is the list of paramater to keep asis

test_against <- lavaan::standardizedSolution(fit3) %>% 
  dplyr::filter(
    pvalue < pvalue_cutoff, rhs != lhs)

test_against_rev <- test_against %>% 
  rename(rhs2 = lhs,
         lhs = rhs) %>% 
  rename(rhs = rhs2)
# for some reason, the rhs and lhs are reversed in the 
# standardizedSolution() output, for some of the values

checked_Pars <-
    check_Pars %>% 
  semi_join(test_against, by = c("lhs", "rhs")) %>% 
  bind_rows(
        check_Pars %>% 
          semi_join(test_against_rev, by = c("lhs", "rhs"))
    )

# I'll have to reverse it myself, and test against both orders
obj@Pars <- keep_Pars %>% 
  bind_rows(checked_Pars)

#let's verify by looking at the list of the edges we removed from the object
# anti_join(original_Pars, obj@Pars)

semPaths(
  obj, 
  "col",
  "std", 
  rotation = 1,
  groups = "latents", 
  pastel = TRUE,
  residuals = FALSE,
  structural = TRUE,
  curvature = 5,
  edge.width = 2,
  edge.label.cex = 1.3,
  mar = c(4, 1, 14, 1)
)
```

The fifth model (M3) attempted to improve on the structure of M2 by adding the direct paths between neuroticism and the two outcome variables.
A comparison of the model M3 with the model M2 indicated that the model M3 did not improve fit, $\Delta \chi^2$(`r anova_m3m2[2, 6]`) = `r round(anova_m3m2[2, 5], 2)`, $p =$ `r round(anova_m3m2[2, 7], 4)`, with the following fit indices: $\chi^2$(`r fit_meas_m3[2]`) = `r fit_meas_m3[1]`, $\chi^2$/df = `r fit_meas_m3[1] / fit_meas_m3[2]`, CFI = `r fit_meas_m3[3]`, NFI = `r fit_meas_m3[5]`, TLI = `r fit_meas_m3[6]`, RMSEA = `r fit_meas_m3[8]`, and SRMS = `r fit_meas_m3[9]`.
The structural component of model M3 is presented in Figure \@ref(fig:semplot) (only the statistical significant path coefficients that the $\alpha$ = 0.5 level are shown).

```{r}
model4 <- "

  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + psc + neuro
  ptss ~ cope + soc + psc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"

fit4 <- sem(
  model4,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

anova_m4m3 <- anova(fit4, fit3)

fit_meas_m4 <- fitMeasures(
  fit4, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

```{r}
model5 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ cope + soc + nsc + neuro
  ptss ~ cope + soc + nsc + neuro
  
  # covariances
  self_judgment ~~ self_kindness
"

fit5 <- sem(
  model5,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

anova_m5m3 <- anova(fit5, fit3)

fit_meas_m5 <- fitMeasures(
  fit5, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

Having obtained a model with a good fit to the data, with the following models we tested additional specific substantive questions.
Model 4 removed from model M3 only the direct paths of the negative component of self-compassion.
This modification produced a significant decrease of fit, $\Delta \chi^2$(`r anova_m4m3[2, 6]`) = `r round(anova_m4m3[2, 5], 2)`, $p =$ `r round(anova_m4m3[2, 7], 4)`.
Model 5 removed from model M3 only the direct paths of the positive component of self-compassion.
Also this change produced a significant decrease of fit, $\Delta \chi^2$(`r anova_m5m3[2, 6]`) = `r round(anova_m5m3[2, 5], 2)`, $p =$ `r anova_m5m3[2, 7]`.

```{r}
model10 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ dg_cope*cope + dg_soc*soc + dg_neuro*neuro
  ptss ~ ds_cope*cope + ds_soc*soc + ds_neuro*neuro

  nsc ~ nsc_cope*cope + nsc_soc*soc + nsc_neuro*neuro
  psc ~ psc_cope*cope + psc_soc*soc + psc_neuro*neuro
  
  ptgr ~ ig_nsc*nsc + ig_psc*psc 
  ptss ~ is_nsc*nsc + is_psc*psc
  
  # covariances
  self_judgment ~~ self_kindness
"

fit10 <- sem(
  model10,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

fit_meas_m10 <- fitMeasures(
  fit10, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)
```

We then considered a different also considered a mediation model (M6) with coping, perceived social support, and neuroticism as endogeneous variable, the positive and negative components of self compassion as mediator variables, and post-traumatic growth and post-traumatic stress disorder as endogeneous variables.
The fit of model M6 was very good with the following indices: $\chi^2$(`r fit_meas_m10[2]`) = `r fit_meas_m10[1]`, $\chi^2$/df = `r fit_meas_m10[1] / fit_meas_m10[2]`, CFI = `r fit_meas_m10[3]`, NFI = `r fit_meas_m10[5]`, TLI = `r fit_meas_m10[6]`, RMSEA = `r fit_meas_m10[8]`, and SRMS = `r fit_meas_m10[9]`.
The structural component of model M6 is presented in Figure \@ref(fig:mediation-model) (only the statistical significant path coefficients at the $\alpha$ = 0.5 level are shown).

```{r mediation-model, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Structural component of a SEM model with the positive and negative components of self-compassion as mediators between coping, perceived social support, and neuroticism, as exogeneous variables, and post-traumatic growth (`ptg`) and PTST (`pts`), as endogeneous variables. `cop` = coping, `soc` = perceived social support, `nsc` = negative self compassion, `psc` = positive self compassion, `ner` = nevroticism."}
std_solution <- lavaan::standardizedSolution(fit10) %>% 
  mutate_if("is.numeric","round",3) %>% 
  filter(op == "~" | op == "~~")

lay <- get_layout(
  "", "cope", "soc",  "neuro", "",
  "nsc", "", "", "", "psc",
  "", "ptss", "", "ptgr", "",
  rows = 3)

graph_data <- prepare_graph(model = fit10, layout = lay)
foo <- edges(graph_data) 
foo1 <- foo[c(2, 7, 9:10, 12, 14, 15, 24:27), ]

graph_data$edges <- foo1

graph_data[[1]]$label <- 
  round(std_solution[c(2, 7, 9, 10, 12, 14, 15, 24:27), 4], 2)

plot(graph_data)
```

```{r}
model11 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  sc =~ self_judgment + isolation + over_identification +
        self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ dg_cope*cope + dg_soc*soc + dg_neuro*neuro
  ptss ~ ds_cope*cope + ds_soc*soc + ds_neuro*neuro

  sc ~ sc_cope*cope + sc_soc*soc + sc_neuro*neuro

  ptgr ~ ig_nsc*sc  
  ptss ~ is_nsc*sc 
  
  # covariances
  self_judgment ~~ self_kindness
"

fit11 <- sem(
  model11,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE
)

fit_meas_m11 <- fitMeasures(
  fit11, 
  c("chisq", "df", "cfi", "cfi.robust", "nfi", "tli", "tli.robust", 
    "rmsea", "srmr")
)

anova_m11m10 <- anova(fit11, fit10)
```

Model M7 was identical to model M6, except that self-compassion was considered as a single latent variable.
The fact that we did not distinguish between the positive and negative components of self-compassion produced a significant decrease of fit, $\Delta \chi^2$(`r anova_m11m10[2, 6]`) = `r round(anova_m11m10[2, 5], 2)`, $p =$ `r anova_m11m10[2, 7]`.

```{r}
model12 <- "
  # post-traumatic growth
  ptgr =~ life_appreciation + new_possibilities + 
         personal_strength + spirituality_changes + 
         interpersonal_relationships
         
  # ptsd
  ptss =~ avoiding + intrusivity + iperarousal
  
  # coping
  cope =~ positive_attitude + problem_orientation 

  # perceived social support
  soc =~ family + friends + significant_other
  
  # self-compassion
  nsc =~ self_judgment + isolation + over_identification
  psc =~ self_kindness + common_humanity + mindfulness
  
  # neuroticism
  neuro =~ negative_affect + self_reproach

  # regressions
  ptgr ~ dg_cope*cope + dg_soc*soc 
  ptss ~ ds_cope*cope + ds_soc*soc 

  nsc ~ nsc_cope*cope + nsc_soc*soc 
  psc ~ psc_cope*cope + psc_soc*soc 
  neuro ~ n_cope*cope + n_soc*soc
  
  ptgr ~ ig_nsc*nsc + ig_psc*psc + ig_neuro*neuro
  ptss ~ is_nsc*nsc + is_psc*psc + is_neuro*neuro
  
  # covariances
  self_judgment ~~ self_kindness
"

fit12 <- sem(
  model12,
  data = clean_dat,
  estimator = "MLM",
  std.lv = TRUE,
  optim.dx.tol = TRUE
)

anova_m12m10 <- anova(fit12, fit10)
```

In a further model comparison, we considered the model M8, which is identical to model M6, except that neuroticism is used as a mediating variable, together with the two components of self-compassion, instead of being an exogenous variable.
The fit of model M8 was very bad and statistically significantly worse than the fit of model M6, $\Delta \chi^2$(`r anova_m12m10[2, 6]`) = `r round(anova_m12m10[2, 5], 2)`, $p =$ `r anova_m12m10[2, 7]`.
We take this as indicating that neuroticism is unlikely to play the role of a mediating variable, together with the two components of self compassion, between the variables presently considered.

```{r}
fit3_ml <- sem(
  model3,
  data = clean_dat,
  std.lv = TRUE
)

fit10_ml <- sem(
  model10,
  data = clean_dat,
  std.lv = TRUE
)

vuong_out <- vuongtest(fit3_ml, fit10_ml)
icci_out <- icci(fit3_ml, fit10_ml)

```

We compared models M3 and M6 with the Vuong closeness test, which indicated that they were too close too be distinguished, $p$ = `r vuong_out$p_omega`.
However, the confidence intervals for the difference in the models' AIC and BIC statistics showed an advantage for the mediation model M6: 95% C.I.
of AIC difference = (`r round(icci_out$AICci[1], 3)`, `r round(icci_out$AICci[2], 3)`) and 95% C.I.
of BIC difference = (`r round(icci_out$BICci[1], 3)`, `r round(icci_out$BICci[2], 3)`).

In order to examine the mediation structure, we compute the bias-corrected bootstrapped confidence interval with 10,000 samples.
Such approach does not rely on distribution assumptions and can be used when the assumptions of large sample size and multivariate normality may not hold (Ryu and Cheong, 2017).
If the confidence intervals do not include zero, then the null hypothesis is rejected, and the mediation effect is non-zero.

```{r mediation-tab}
boot_mediation <- readRDS("boot_mediation.Rds")

foo <- boot_mediation[-c(5, 10, 15), c(1, 5, 6, 9:10)] 

now_names <- c(
   "Ind. eff. coping -> PTSS", 
   "Ind. eff. coping -> PTG", 
   "Tot. eff. coping -> PTSS", 
   "Tot. eff. coping -> PTG", 
   "Ind. eff. soc. supp. -> PTSS",   
   "Ind. eff. soc. supp. -> PTG", 
   "Tot. eff. soc. supp. -> PTSS", 
   "Tot. eff. soc. supp. -> PTG", 
   "Ind. eff. neuro. -> PTSS", 
   "Ind. eff. neuro. -> PTG",  
   "Tot. eff. neuro. -> PTSS", 
   "Tot. eff. neuro. -> PTG"
)

foo$lhs <- now_names

foo %>% 
  knitr::kable(
    col.names = c("Effect", "Estimate", "S.E.", "C.I. lower", "C.I. upper"),
    digits = 3,
    row.names = FALSE,
    booktabs = TRUE,
    caption = 'Indirect and total effects for the three endogeneous variables Coping (coping), Perceived social support (soc. supp.), and Neuroticism (neuro.) on post traumatic stress (PTSS) and post traumatic growth (PTG). S.E. = standard error; `C.I. lower` and `C.I. upper` = lower and upper limits of the 95\\% bootstrap confidence interval.')
```

We found no (statistically significant) direct effect of coping on PTSS nor on PTG.
Conversely, we found evidence of an indirect effect of coping on PTG, with a total effect of 0.238, 95% CI = [0.127, 0.355].
This suggests a fully mediated effect of coping on PTG.
Instead, there was no strong evidence of a mediated effect of coping on PTSS because the confidence interval for the indirect effect included zero, 95% CI = [-0.026, 0.219].

There was no clear evidence of a direct effect of perceived social support on PTSS, nor evidence of an indirect effect, 95% CI = [-0.057, 0.037].
Instead, we found evidence of a direct effect of perceived social support on PTG, nor evidence of an indirect effect, 95% CI = [-0.023, 0.031].
Although the 95% CI of the total effect did not include zero [0.085, 0.282], it is difficult to interpret.

Finally, we found no clear evidence of a direct effect of neuroticism on PTSS, but we found evidence of an indirect effect, 95% CI = [0.283, 0.755], with a total effect of 0.571, 95% CI = [0.451, 0.711].
This suggests that the effect of neuroticism on PTSS is fully mediated.
Conversely, we found no clear evidence of a direct effect of neuroticism on PTG, nor evidence of an indirect effect of neuroticism on PTG, with a total effect of 0.032, 95% CI = [-0.184, 0.232].

# Discussion

Main points.

for a recent development, see also @gu2020development

-   We found evidence that a model with a single component of SC is inadequate, whereas a model which distinguishes the positive and negative component of SC is more adequate to account for the data.

-   We found evidence of a better fit for a model which adds the positive component of SC to a model with only the negative component of SC.

-   Consistently with (ref), we found evidence that SC is better understood as a mediation variable.

-   We found evidence that a model which include nevroticism is more adequate than a model with only SC.

In conclusion, we found not evidence that the construct of SC can be subsumed by the constructs of negative affect and nevroticism.
Instead, we found evidence, consistently with (ref), that SC plays a mediating role between coping, perceived social support, and nevroticism, on the one side, and PTSS and PTG, on the other.
Importantly, we also found that nevroticism and SC are both important in accounting for PTSS and PTG -- in other words, we cannot reduce SC to nevroticism.
Instead, our data suggest that the two components of SC and nevroticism play a different structural role in a nomological network having PTSS and PTG as endogenous variables.

\newpage

# References

```{=tex}
\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}
```
::: {#refs custom-style="Bibliography"}
:::

```{r create_r-references}
r_refs(file = "self-compassion.bib")
```

\endgroup

\renewcommand{\appendixname}{Supplementary Information}

```{r render_appendix, include = FALSE}
render_appendix("appendix.Rmd")
```

---
appendix: "appendix.Rmd"
---



<!--chapter:end:self_compassion.Rmd-->

---
title: "Supplemental Materials to Accompany: Self-compassion"
author: "Masked for Review"
date: '`r format(Sys.Date(), "%d %B %Y")`'
geometry: margin = 1in
output: 
  pdf_document:
    latex_engine: xelatex
    fig_caption: TRUE  
    toc: TRUE
    toc_depth: 3
    keep_tex: TRUE
header-includes:
   - \usepackage{setspace}
   - \usepackage{caption}
   - \usepackage{float}
   - \usepackage{fontspec}
   - \usepackage{pdflscape}
   - \doublespacing
   - \floatplacement{figure}{H}
params:
  SavePlots: FALSE ## Save plots to external files
editor_options: 
  markdown: 
    wrap: 72
---

\newpage

```{r setup, echo = TRUE, warning = FALSE, message = FALSE}
## ~~~~~~~~~~~~~~~~~~ ##
#### Setup R Script ####
## ~~~~~~~~~~~~~~~~~~ ##

## Set default knitr options for R Markdown
knitr::opts_chunk$set(echo    = TRUE,
                      cache   = TRUE,
                      warning = FALSE,
                      message = FALSE)

## ~~~~~~~~~~~~~~~~~ ##
#### Load Packages ####
## ~~~~~~~~~~~~~~~~~ ##

## If pacman is not installed, install it
if (!require("pacman")) install.packages("pacman")

## Load required packages
pacman::p_load(kableExtra, ## Format tables in latex
               psychmeta,  ## Composite correlation
               # stargazer,  ## Simple tables of regression output
               # tidyverse,  ## Data and string manipulation
               fungible,   ## Conduct factor analyses
               magrittr,   ## Use the pipe operator
               ggplot2,    ## Create plots
               stringr,    ## String manipulation
               ggExtra,    ## Marginal boxplot added to ggplot
               readxl,     ## Load data from Microsoft Excel file
               psych,      ## Misc analyses (parallel analysis)
               knitr,      ## LaTeX friendly tables
               dplyr,      ## Data wrangling
               here)       ## Load scripts dynamically

## Set the seed for reproducibility
SEED <- 123

## Set the particular type of random number generator
set.seed(seed = SEED,
         kind = "L'Ecuyer-CMRG")

```

```{r User Written Functions}
## ~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Define User Functions ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~ ##
## This function is internal to fungible::faMain() but used as a standalone function.

## Guttman's Factor Indeterminacy Index
factorIndeterminacy <- function(Lambda, 
                                PhiMat,
                                SampCorr) {
  ## Purpose: Compute Guttman (1955) factor indeterminacy index
  ##
  ## Args:    Lambda:   (Matrix) Rotated factor loadings matrix
  ##          PhiMat:   (Matrix) Factor correlation matrix
  ##          SampCorr: (Matrix) Sample correlation matrix
  
  ## Fator structure matrix (for either oblique, orthogonal, or bifactor model)
  facStruct <- Lambda %*% PhiMat
  
  ## If SampleCorr is non-positive definite (non invertible), give error
  Rinv <- try(solve(SampCorr), silent = TRUE)
  
  if ( class(Rinv) == "try-error") {
    ## If non-invertible, give a warning
    warning("\n\nEncountered a singular R matrix when computing 
            factor indeterminancy values\n")
    
    ## Return a vector of NAs rather that indeterminacy values
    return( rep(NA, ncol(Lambda) ) )
    
  } # END if ( class(Rinv) == "try-error") 
  
  ## Factor indeterminacy solution
  sqrt( diag( t(facStruct) %*% Rinv %*% facStruct))
  
} # END factorIndeterminacy

## Create fac scores by unit weighting everything, using arbitrar cutoff value
UnitWeightFacScore <- function(stndData,      ## Standardized subject responses
                               Lambda,        ## Bifactor loadings matrix
                               FacLoadCutoff = .30) {  ## Cutoff value to use
  ## Purpose: Compute unit-weighted factor scores
  ##
  ## Args:    stndData:      (Matrix) subject scale scores in Z-score form
  ##          Lambda:        (Matrix) Bifactor loadings matrix
  ##          FacLoadCutoff: (Scalar) Fac loading cut-off score, default of .30
  ##
  ## Output:  scores:        (Matrix) Est subject scores on each factor 
  ##          r.scores:      (Matrix) Cor among the estimated factor scores
  ##
  
  ## Simple error check, is column order held constant across matrices?
  if (all.equal(colnames(stndData), rownames(Lambda)) == FALSE) {
    stop("Bifactor model and raw data do not have consistent variable order")
  } # END if (all.equal(colnames(scaleData), rownames(ConscDSL)) == FALSE) 
  
  ## Create a signed matrix marking which indicators load onto which factors
  signMatrix <- Lambda
  
  ## All loadings, in absolute value >= cutoff set to 1
  signMatrix[abs(signMatrix) >= FacLoadCutoff] <- 1
  
  ## All other loadings, set to zero
  signMatrix[signMatrix != 1] <- 0
  
  ## Place original signs back in if negative loadings exist
  signMatrix <- signMatrix * sign(Lambda)
  
  ## Create unit weighted factor scores for each factor
  FacScores <- stndData %*% signMatrix
  
  ## Find the intercorrelations among factor scores
  rFacScores <- cor(FacScores)
  
  ## Compile results into a list
  list("scores"   = FacScores,
       "r.scores" = rFacScores)
  
} # END UnitWeightFacScore

```

# Description of the Online Supplement

This online supplement contains all of the code used to analyze the two
datasets included in the manuscript. All code is accompanied by comments
to at least generally describe the rationale and purpose for each line
or section of code.

The online supplement is split into separate sections. The first section
details the results of the re-analyzed Toker & Ackerman (2012)
vocational interests data using a bifactor model. The second section
details the bifactor analyses conducted on the developmental performance
dataset (Hoffman et al., 2010). The Third section includes all conducted
analyses of the conscientiousness (personality) dataset.

# Reanalysis of Toker & Ackerman (2012)

In their study assessing STEM student interest in complex careers, Toker
and Ackerman (2012) report the results of an oblique factor analysis.
Using their obtained factor pattern and factor correlation matrix, we
can conduct a second-order factor analysis and transform the pattern of
loadings using the Schmid-Leiman procedure.

Note that the authors did not give more specification to how their
correlated factor model was estimated (e.g., which oblique rotation, the
criterion for factor extraction convergence). Below, we applied
principal axis factoring, the same factor extraction method used by
Toker and Ackerman (2012).

# Developmental Performance Data

## Data Wrangling

The Hoffman et al (2010) dataset includes managerial performance
evaluation ratings (for developmental, non-administrative purposes) from
seven different sources. Those raters are as follows: two bosses, two
peers, two subordinates, and self-reported performance ratings. All
raters assessed many different items that were aggregated into three
subdimensions of performance: technical performance, interpersonal
performance, and leadership performance.

For the manuscript, we computed composite correlations for all three
rating sources that provided two ratings (i.e., bosses, peers, and
subordinates). Considering that each rater provided scores on three
subdimensions, the four (three composited + one self-report) rating
sources yielded a total of 12 factor indicators (i.e., observed
variables).

The following code reproduces the published correlation matrix then it
computes the composite correlations. The composited intercorrelation
matrix is printed below.

## Dimensionality Detection

The number of dimensions (i.e., the number of factors to retain) was
determined via multiple methods. Though we primarily relied on deductive
reasoning, we also provide code to demonstrate how to quantify the
number of dimensions.

### Scree Plot

A scree plot for common factor models require the communality values to
be placed on the main diagonal. Generally, communalities are
estimated---via the squared multiple correlation (SMC). Here, however,
we know the true number of factors so we can directly compute the
communalities (i.e., by conducting a factor analysis with the correct
number of dimensions and determine communalities directly. Communalities
are invariant under rotation). Nevertheless, code is provided to
estimate communalities via the SMC approach.

The scree plot showed two steep drop-offs in eigenvalues. The first
eigenvalue is notably larger indicating that the first-order common
factors are indeed correlated. The second drop-off denotes that there
are four common factor present and the remaining eigenvalues are
negligible in magnitude. Given the large dataset, eigenvalues have low
sampling variability so it is easy to see that four factors should be
extracted.

```{r Performance Scree Plots}
## ~~~~~~~~~~~~~~ ##
#### Scree Plot ####
## ~~~~~~~~~~~~~~ ##

SCS_corr_mat <- lavaan::lavCor(d, ordered = names(d))



## Directly compute the communalities (rather than estimate) 
## Communalities are invariant under rotation, no need to rotate
## We already know the model has 4 factors (i.e., rating sources)
faUnrotatedOutput <- faMain(R          = SCS_corr_mat, 
                            numFactors = 6, 
                            rotate     = "none")

## Compute communalities (sum of squared loadings in each row)
HierCommunalities <- apply(faUnrotatedOutput$loadings^2, 1, sum)

## Estimate communality via squared multiple correlation (SMC)
# HierCommunalities <- 1 - 1 / diag(solve(HoffmanCorrMat))

## Reduce diagonal of correlation matrix to estimated communalities
ReducedHoffCorr <- SCS_corr_mat - diag(1 - HierCommunalities)

## Plot the eigenvalues of the reduced correlation matrix
eigen(ReducedHoffCorr)$val %>% 
  plot(type = "b", ## Line connecting points on plot
       main = "Scree Plot: Performance Data",
       xlab = "Factor number",
       ylab = "Eigenvalue for each factor",
       ylim = c(-.80, 9))
```

### Parallel Analysis

Though we did not rely on parallel analyses to determine the
dimensionality of the performance data, we provide that code below for
illustrative purposes.

Note that in large samples, parallel analyses are prone to
over-extracting the number of factors. The mechanics of parallel
analysis requires sampling of random correlation matrices to find the
distribution of eigenvalues for random data. As expected, parallel
analysis recommended the overextraction of factors. Specifically, it
recommended the extraction of six factors, two more than were actually
extracted. Note that with 12 variables, a maximum of seven factors can
be extracted while still yielding an identified first-order model.

```{r Performance Parallel Analysis}

## Maximum number of first-order factors to extract for an identified solution
# Ledermann(numVariables = nrow(HoffmanCorrMat))$numFactors

## ~~~~~~~~~~~~~~~~~~~~~ ##
#### Parallel Analysis ####
## ~~~~~~~~~~~~~~~~~~~~~ ##

# Parallel analysis of the Hoffman et al data set
psych::fa.parallel(x           = SCS_corr_mat,
                   n.obs       = 744,
                   fa          = "fa",
                   fm          = "uls",  
                   SMC         = TRUE,
                   n.iter      = 50,
                   show.legend = FALSE,
                   main        = "Parallel Analysis: Hierarchical Data")
```

### Empirical Kaiser Criterion

The empirical Kaiser criterion (EKC) is a recent advancement of the
popular Kaiser criterion (i.e., retaining all factors with eigenvalues
\> 1.0). Kaiser's criterion is frequently found to be inaccurate due to
(a) failing to account for sampling variability in eigenvalues and (b)
the serial nature of eigenvalues (e.g., the eigenvalue of the $n^{th}$
factor depends, in part, on the eigenvalue of the $(n-1)^{th}$ factor).

```{r Performance EKC Analysis}
## ~~~~~~~~~~~~ ##
#### EKC Plot ####
## ~~~~~~~~~~~~ ##

## Determine the dimensionality from the EKC procedure
perfEKC <- faEKC(R     = SCS_corr_mat,
                 NSubj = 744,
                 Plot  = TRUE)
```

## Detecting local minima problems

Due to space limitations, we were unable to describe the issue of local
minima in factor analysis (and its relevance to bifactor models more
specifically). The oblique geomin rotation is prone to yielding local
solutions. Local solutions mean that applying several geomin rotations
from different starting values might yield multiple *different*
solutions. In oversimplified terms, these result from the optimization
routine--a routine seeking to minimize a non-smooth function--getting
'stuck' in a local minima rather than finding *the* minimum. Thus, to
increase our chance of reporting the solution from the global minimum,
we conduct all rotations 100 times and retain the solution with the
smallest discrepancy function. For more details, see the help
documentation for the faMain function.

The code below conducted the first step of a Schmid-Leiman
transformation. Namely, the code estimated a first-order correlated
factor model--one factor for each proposed group factor. Note that local
minima cannot be found in the second-order factor model *in the case of
one general factor*. This is because no rotation is applied in
one-factor models.

```{r Performance Detect Local Minima}
## ~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Local Minima Detection ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Conduct 1st-order factor analysis of a multi-order SL solution
perfDetectLocalMin <- 
  faMain(R             = SCS_corr_mat,
         numFactors    = 4,
         facMethod     = "fals",
         rotate        = "geominQ",
         rotateControl = 
           list(numberStarts = 100,   ## Random start configs
                delta        = .01,   ## Geomin tuning param
                standardize  = "none"))

## If multiple local solutions found, give a warning
if (perfDetectLocalMin$numLocalSets > 1) {
  cat("Multiple local solutions found. 
      Consider applying a Cureton-Mulaik standardization procedure.")
} # END if (perfDetectLocalMin$numLocalSets > 1)

```

## Comparing Oblique Rotations with the Schmid-Leiman Procedure

The code below reproduces the second figure in the manuscript comparing
general factor saturations of 1,001 oblique rotations in the
higher-order factor model. All factors were estimated by an ordinary
least squares extraction algorithm. An oblique Crawford-Ferguson (CF)
rotation was applied to each obtained first-order factor model.
Specifically, CF rotations apply a tuning parameter ($\kappa$) that
proportionally weights the minimization of either column complexity
(i.e., finding as many zero factor loadings in each column as possible)
or row complexity (i.e., finding as many zero factor loadings per row as
possible). A CF $\kappa$ value of zero seeks to purely minimize row
complexity whereas a value of 1.0 purely minimizes column complexity. A
$kappa$ value of .50 gives equal weight to minimizing both. $\kappa$
values can therefore be interpreted as the proportion of weight given to
minimizing row complexity in the rotational criterion.

```{r Rotational Indeterminacy}
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Rotational Indeterminacy ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Create a vector of the Crawford-Ferguson tuning parameters (range from 0 to 1)
CFKappa <- seq(from       = 0,
               to         = 1,
               length.out = 10) ## Equal increments

## The number of kappa parameterizations to iterate across
numKappaParams <- length(CFKappa)

## Pre-allocate a vector to store factor analytic results for each kappa parameterization
resultsVector <- rep(NA, numKappaParams)

## Combine the kappa parameter with its resultant general factor saturation index
resultsDF <- data.frame("Kappa"  = CFKappa,
                        "OmegaG" = resultsVector)

## A for-loop structure to analyze Hoffman's data using CF kappa param
for (iterCFParam in 1:numKappaParams) { 

  ## Set seed for reproducibility purposes
  set.seed(iterCFParam * 123)

  ## Schmid-Leiman rotation using the CF family of oblique rotations
  FAOutput <-
    SchmidLeiman(R             = SCS_corr_mat,
                 numFactors    = c(4, 1),
                 facMethod     = "fals",
                 rotate        = "cfQ",
                 rotateControl =
                   list(numberStarts = 20,
                        kappa        = CFKappa[iterCFParam],
                        standardize  = "none"))$B

  ## Compute the general factor saturation within the estimated bifactor model
  GenFacSatur <- Omega(lambda = FAOutput,
                       genFac = 1)$OmegaGeneral

  ## Save the output in the allotted results vector
  resultsDF$OmegaG[iterCFParam] <- GenFacSatur

  ## Print statement showing iteration progression
  # cat("Finished condition number:", iterCFParam, "of", numKappaParams, "conditions \n")

} # END for (iterCFParam in seq_along(numKappaParams))


## Compare CF rotations with geominQ
## Geomin is not in the CF family of rotations, hence it is estimated separately
geominSL <-
  SchmidLeiman(R             = SCS_corr_mat,
               numFactors    = c(4, 1),
               facMethod     = "fals",
               rotate        = "geominQ",
               rotateControl =
                 list(numberStarts = 20,
                      kappa        = CFKappa[iterCFParam],
                      standardize  = "none"))$B %>%
  Omega(lambda = ., genFac = 1)
```

```{r Plot factor saturation by CF tuning parameters}
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Plot Factor Saturation of Rotations ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Only save an external copy of the plot if specified to
if (params$SavePlots == TRUE) {
  
  ## Initiate a .png file to save the subsequent ggplot2 image
  png(file   = here("Analyses", "Figures", "Comparing_Oblique_Rotations_SL.png"),
      width  = 6,
      height = 8,
      units  = "in",
      res    = 300)

} # END if (params$SavePlots == TRUE) 

## Plot the obtained data
RotIndeterPlot <- ggplot(data  = resultsDF,
                         aes(x = Kappa,
                             y = OmegaG)) +
  ## Add scatterplot
  geom_point() +
  ## Label the axes
  labs(title = "Comparing Oblique Rotations in the SL procedure",
       x     = ~ paste(kappa, " Parameter Value"),
       y     = ~ paste(omega[h], " General Factor Saturation")) +
  ## Horizontal line demarcating the geomin-based threshold
  geom_hline(aes(yintercept = geominSL$OmegaGeneral)) +
  ## Alter the y axis (limits and tick marks)
  scale_y_continuous(limits = c(.35, .60),
                     expand = c(0, 0),
                     breaks = seq(.35, .60, .05)) +
  ## Alter the x axis (limits and tick marks)
  scale_x_continuous(limits = c(0, 1),
                     expand = c(.01, .01)) +
  ## Add text to the figure
  geom_text(aes(0,
                geominSL$OmegaGeneral,
                label = "geomin rotation",
                vjust = -1,
                hjust = -1.7)) +
  ## Add a particular theme to the plot
  papaja::theme_apa()

## Add boxplot to the "y" axis to show density
MarginalRotIndeterPlot <- 
  ggMarginal(RotIndeterPlot,
             type    = "boxplot", ## Add boxplot to exterior part of axes
             margins = "y")        ## Only add boxplot to y-axis

## Produce the plot
MarginalRotIndeterPlot

## Only save the plots if the markdown parameter specifies it
if (params$SavePlots == TRUE) {
  
  ## Finalize the .png file of the above plot
  dev.off()
  
} # END if (params$SavePlots == TRUE) 
```

## Bifactor Analysis

A second-order Schmid-Leiman exploratory bifactor model was estimated.
Factors were extracted via the ordinary least squares (OLS) factor
extraction algorithm. The first-order factors were obliquely rotated by
the geomin rotation criterion. To mitigate the role of local solutions
in the geomin rotation, the first-order factors were rotated from 100
different random starting configurations. From the 100 alternative
solutions, the rotation with the smallest criterion value was retained
as the global minimum. No local solutions were found in the previous
section, therefore no standardization routines (i.e., Kaiser
normalization or Cureton-Mulaik standardization) were applied.

Appended to the bifactor loadings matrix are two additional columns,
$h^2$ and I-ECV, displaying the communality and item explained common
variance results (respectively). The remainder of the table contains the
bifactor loadings obtained by an SL transformation of a second-order
factor model.

```{r Performance Bifactor Analysis}
## ~~~~~~~~~~~~~~~~~~~~~ ##
#### Bifactor Analyses ####
## ~~~~~~~~~~~~~~~~~~~~~ ##

## Conduct tranditional Schmid-Leiman procedure, do not round output
SLOutput <- 
  SchmidLeiman(R          = HoffmanCorrMat, ## Corr matrix
               numFactors = c(4, 1),        ## Number of factors per level
               facMethod  = "fals",         ## Fac extraction method
               rotate     = "geominQ",      ## Rotational criterion
               rotateControl = 
                 list(numberStarts = 100,   ## Random start configs
                      delta        = .01,   ## Geomin tuning param
                      standardize  = "none"))$B    

## Add column names to the SL Bifactor output
colnames(SLOutput) <- c("Performance", "Boss", "Peer", "Subordinate", "Self")

## Sort the row order into 'hallow staircase' pattern
SortedSL <- faSort(fmat     = SLOutput,
                   BiFactor = TRUE)$loadings

## Compute the item communalities
Communality <- apply(SortedSL^2, 1, sum)

## Compute the item explained common variance (I-ECV)
IECV <- apply(SortedSL^2, 1, function(x) x[1] / sum(x))

## Add columns for the communality and and I-ECV values
SL <- cbind(SortedSL, 
            Communality, 
            IECV) %>% round(2)

## Give clear row and column names
dimnames(SL) <- 
  list(rep(c("Technical", "Interpersonal", "Leadership"), 4), 
       c("Performance", "Boss", "Peer", "Subordinate", "Self", 
         "$h^2$", "I-ECV"))
```

```{r Table Performance Bifactor Model}

## Create table caption
TabCaption <- c("Schmid-Leiman Bifactor Solution of the
                Multisource Performance Ratings")

## Remove newlines and whitespaces
TabCaption %<>% str_replace_all("[\n]", "") %>% str_squish()

## Create table using knitr's kable function
kable(SL,
      # format    = "latex",
      caption   = TabCaption,
      booktabs  = TRUE,
      longtable = FALSE,
      escape    = FALSE,
      linesep   = "") %>%
  
  ## Row header for the rating sources
  pack_rows("Boss Ratings", 1, 3) %>% 
  pack_rows("Peer Ratings", 4, 6) %>% 
  pack_rows("Subordinate Ratings", 7, 9) %>% 
  pack_rows("Self Ratings", 10, 12) %>% 
  
  ## Column header to identify column contents
  add_header_above(c(" " = 2, "Group factors" = 4, "Item indices" = 2)) %>% 
  
  ## Add a footnote
  footnote(general        = 
            "$h^2$ = item communality; I-ECV = item explained common variance.",
           threeparttable = TRUE,
           escape         = FALSE)
```

## Model-Based Reliability Analyses ($\omega$)

The table below produces the model-based reliability values (i.e.,
$\omega$ and its cognates). There are three types of $\omega$ values
reported in the table below. Overall $\omega$ representing the
proportion of the overall, unit-weighted score variance that is
accounted for by the latent factors. Next, omega hierarchical (i.e.,
$\omega_h$) represents the proportion of the overall, unit-weighted sum
score variance that is accounted for by a particular factor. Lastly,
omega hierarhical subscale (i.e., $\omega_{hs}$) represents the
proportion of the overall, unit-weighted sum score variance *for a
subset of the items* that is accounted for by a particular factor. For
instance, computing $\omega_{hs}$ for the self-report ratings only
included the rows with salient loadings on the self-report group factor.
Here, "salient loadings" are those factor loadings $\ge |.30|$ in
magnitude.

```{r Performance Omega}
## ~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Omega Computations  ####
## ~~~~~~~~~~~~~~~~~~~~~~~ ##

## Overall omega estimate (all common factors / common + uniqueness)
HoffmanOmegaTotal <- Omega(SLOutput)$OmegaTotal %>% round(2)

## Omega hierarchical (gen factor / common + uniqueness)
HoffmanOmegaGeneral <- Omega(SLOutput)$OmegaGeneral %>% round(2)

## Omega hierarchical Boss Subscale 
BossSubscaleUniqueness <- 1 - (SLOutput[7:9, ]^2 %>% apply(1, sum))
BossNumerator <- sum(SLOutput[7:9, "Boss"])^2
BossDenominator <- 
  cbind(SLOutput[7:9, c("Performance", "Boss")], BossSubscaleUniqueness) %>% 
  apply(2, function(x) sum(x)^2) %>% 
  sum
BossSubscaleOmega <- (BossNumerator / BossDenominator) %>% round(2)

## Omega hierarchical Peer Subscale 
PeerSubscaleUniqueness <- 1 - (SLOutput[4:6, ]^2 %>% apply(1, sum))
PeerNumerator <- sum(SLOutput[4:6, "Peer"])^2
PeerDenominator <- 
  cbind(SLOutput[4:6, c("Performance", "Peer")], PeerSubscaleUniqueness) %>% 
  apply(2, function(x) sum(x)^2) %>% 
  sum
PeerSubscaleOmega <- (PeerNumerator / PeerDenominator) %>% round(2)


## Omega hierarchical Subordinate Subscale 
SubSubscaleUniqueness <- 1 - (SLOutput[1:3, ]^2 %>% apply(1, sum))
SubNumerator <- sum(SLOutput[1:3, "Subordinate"])^2
SubDenominator <- 
  cbind(SLOutput[1:3, c("Performance", "Subordinate")], 
        SubSubscaleUniqueness) %>% 
  apply(2, function(x) sum(x)^2) %>% 
  sum
SubSubscaleOmega <- (SubNumerator / SubDenominator) %>% round(2)


## Omega hierarchical Self Subscale
SelfSubscaleUniqueness <- 1 - (SLOutput[10:12, ]^2 %>% apply(1, sum))
SelfNumerator <- sum(SLOutput[10:12, "Self"])^2
SelfDenominator <- 
  cbind(SLOutput[10:12, c("Performance", "Self")], SelfSubscaleUniqueness) %>% 
  apply(2, function(x) sum(x)^2) %>% 
  sum ## Sum the above values across all factors
SelfSubscaleOmega <- (SelfNumerator / SelfDenominator) %>% round(2)

```

```{r Performance Omega Table}
## Create a table of the omega values
data.frame("Overall"     = HoffmanOmegaTotal,
           "Performance" = HoffmanOmegaGeneral,
           "Boss"        = BossSubscaleOmega,
           "Peer"        = PeerSubscaleOmega,
           "Subordinate" = SubSubscaleOmega,
           "Self"        = SelfSubscaleOmega) %>% 
  
  ## Transpose the data.frame to be a column vector
  t() %>% 
  
  ## Create a table in LaTeX
  kable(#format    = "latex",
        caption   = "Reliability Indices for the Performance Bifactor Model",
        col.names = c("$\\omega$"),
        booktabs  = TRUE,
        longtable = FALSE,
        escape    = FALSE,
        linesep   = '') %>% 
  
  ## Row headings
  pack_rows("Omega full scale", 1, 1) %>% 
  pack_rows("Omega hierarchical", 2, 2) %>% 
  pack_rows("Omega hierarchical subscale", 3, 6) %>% 
  
  ## Create extra column width in the first column
  column_spec(column = 1, 
              width  = "2.5in") %>% 
  
  ## Create table footnote
  footnote(general = 
             "Row headers denote which type of omega values are estimated.",
           threeparttable = TRUE)
  
```

## Factor Determinacy

The following section is purely for illustrative purposes as no factor
scores were estimated (nor could they be because no raw data were
available). Moreover, there are no external criteria with which to
relate to the estimated factor scores. Nevertheless, factor
indeterminacy metrics were calculated.

The values reported below are the factor indeterminacy ($\rho$) values.
These values represent the correlation between factor scores and the
factors. Stated differently, these values represent the multiple
correlation between the observed variables and the latent factor. The
values range between zero and unity with larger values indicating that
factor scores are better determined (and that the observed variables are
related to the latent factor). Empirically, factor determinacy is a
function of (a) factor loading strength and (b) the number of salient,
non-trivial factor indicators for a given factor. General factors, by
definition, have more salient loadings than the group factors but there
is no guarantee that general factors are better determined (as is shown
below). Moreover, recommendations suggest that factor determinacy values
less than .90 are ill-suited for practical applications of factor score
estimation (e.g., relating factors to external criteria).

Notice that in the present developmental performance dataset, the
general factor was the least-well determined factor.

```{r Performance Factor Determinacy}
## ~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Factor Indeterminacy ####
## ~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Create a footnote to include in the table below
TabFootnote2 <- c("$\\\\rho$ = correlation between factor scores and factors, 
$\\\\rho^2$ = squared correlation between factor scores and factors, 
MPC = minimum possible correlation between sets of factor scores.")

## Tidy the footnote caption
TabFootnote2 %<>% str_replace_all("\n", "")

## Quantify the degree of factor determinacy for the bifactor model
## Correlations between factor scores and factors
HoffmanFacIndeter <- 
  factorIndeterminacy(Lambda   = SLOutput,
                      PhiMat   = diag(ncol(SLOutput)), ## Identity matrix
                      SampCorr = HoffmanCorrMat) %>% 
  as.data.frame() ## Convert to column vector

## Squared factor score determinacy value
HoffmanRhoSqr <- HoffmanFacIndeter^2

## Minimum possible correlation between sets of factor scores
HoffmanMPC <- 2 * HoffmanRhoSqr - 1

## Add row names corresponding to the tabled values
rownames(HoffmanFacIndeter) <- colnames(SLOutput)

## Create data.frame of the factor indeterminacy values
data.frame(HoffmanFacIndeter, 
           HoffmanRhoSqr, 
           HoffmanMPC) %>% 
  
  ## Table the factor indeterminacy values
  kable(caption   = 
          "Factor Indeterminacy Values for the Performance Bifactor Model",
        col.names = c("$\\rho$", "$\\rho^2$", "MPC"),
        booktabs  = TRUE,  
        longtable = FALSE,  
        escape    = FALSE,
        digits    = 2,
        linesep   = "") %>% 
  
  ## Create footnotes to go with the table
  footnote(general        = TabFootnote2,
           threeparttable = TRUE,
           escape         = FALSE)
```

# Conscientiousness Personality Data

## Data Wrangling

The conscientiousness dataset included 11 subdimensions (i.e., facet
scales) of conscientiousness. All ratings were provided by 761 college
students from a large Midwestern university.

Scale-level statistics (e.g., responses, mean, sd, etc) and the full
intercorrelation matrix of the conscientiousness scale scores are
provided in the tables below.

```{r Conscientiousness Data Wrangling}
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Load Conscientiousness Data ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Load the data
rawData <- read_xlsx(here("Data Files", 
                          "Cleaned Conscientiousness Raw Data.xlsx"))

## View the data and its structure (uncomment to see)
# View(rawData)

## Names of conscientiousness scale scores
## Ignore "Participants" identifier column
ConScales <- rawData[, -1] %>% colnames
```

```{r Conscientiousness item statistics}
## ~~~~~~~~~~~~~~~~~~~ ##
#### Item Statistics ####
## ~~~~~~~~~~~~~~~~~~~ ##

## Create table footnote 
TabFootnote4 <- c("n = number of responses to the scale, sd = standard
                  deviation, trimmed = mean of the trimmed data, mad = median 
                  absolute deviation (i.e., deviation, in absolute value, from 
                  the median), min = minimum, max = maximum, se = 
                  standard error.") %>% 
  str_replace_all("\n", "") %>% 
  str_squish()

## Identify scale-level descriptive statistics
itemStats <- rawData %>%               
  select(-Participant) %>%   ## Only select scale scores
  describe() %>%          ## Compute item statistics
  select(-vars)

  
## Table the results
kable(itemStats,
      booktabs  = TRUE,
      caption   = "Conscientiousness Scale Descriptive Statistics",
      linesep   = "",
      digits    = 2,
      longtable = FALSE) %>% 
  
  ## Create a footnote to describe the column values
  footnote(general        = TabFootnote4,
           threeparttable = TRUE)

## Create matrix of standardized scale scores (used for factor score estimates)
scaleData <- rawData %>%  ## From the Raw Data
  select(-Participant) %>%   ## Extract conscientiousness scale scores
  scale(center = TRUE,    ## Mean center the data
        scale  = TRUE)    ## Unit variance

## Generate an item intercorrelation matrix
corData <- cor(scaleData, 
               use    = "pairwise.complete.obs", ## Pairwise deletion
               method = "pearson")               ## Pearson correlation

## Add numbers to the front to correspond with numbered column headers
rownames(corData) <- paste0(rownames(corData), " (", seq_len(ncol(corData)), ")")
```

```{r Conscientiousness correlation matrix}
## Create a correlation matrix table
kable(corData,
      booktabs  = TRUE,
      caption   = "Conscientiousness Scale Intercorrelation Matrix",
      linesep   = "",
      col.names = paste0("(", seq_len(ncol(corData)), ")"),
      digits    = 2,
      longtable = TRUE) %>% 
  
  ## Change table placement and make it full width
  kable_styling(latex_options = c("striped", "hold_position")) %>%
  
  ## Orient the page in landscape view to better display the table
  landscape()
```

## Dimensionality Detection

Mirroring the modeling strategy for the developmental performance data,
we used a combination of theoretical and empirical strategies to
identify the plausible range of factors.

### Scree Plot

Unlike in the performance data above, we did not have as strong of an *a
priori* estimate of the true number of factors. Therefore, we estimated
communalities using the traditional squared multiple correlation (SMC)
approach. SMC values are the squared multiple correlation for predicting
one variable from all other variables. Such values are placed on the
diagonal of the correlation matrix as a proxy for the estimated
communality values. Eigenvalues are obtained from this reduced
correlation matrix (i.e., a correlation matrix with communality values
on its diagonal) to create the scree plot.

The depicted scree plot shows two noteworthy drop-offs in eigenvalues.
The first drop-off indicates a strong general factor whereas the
remaining second or third eigenvalues represent the (plausible) range
for the number of group factors present in the dataset. Thus, the scree
plot recommended the extraction of either two or three group factors in
a constrained hierarchical bifactor model.

```{r Conscientiousness Scree Plot}
## ~~~~~~~~~~~~~~ ##
#### Scree Plot ####
## ~~~~~~~~~~~~~~ ##

## Estimate communalities via SMC
Communalities <- 1 - 1 / diag(solve(corData))

## Insert communalities as the diagonal elements
reducedConscCorMatrix <- corData - diag(1 - Communalities)

## Plot the eigenvalues in a Scree Plot
eigen(reducedConscCorMatrix)$val %>% 
  plot(type = "b", ## Line connecting points on plot
       main = "Scree Plot: Conscientiousness Data",
       xlab = "Factor number",
       ylab = "Eigenvalue for each factor",
       ylim = c(-.20, 5.0))
```

### Parallel Analysis

Again, we did not rely on parallel analyses to determine the optimal
number of factors to extract. However, parallel analyses are commonly
applied so we included the code to conduct such analyses. As can be
seen, several of the proposed factors are associated with eigenvalues
that are trivially larger than those of randomly-generated eigenvalues.
Thus, the recommendation to extract six factors is likely too high.
Overextraction is a common problem in parallel analysis when sample
sizes are notably larger than the norm. Indeed, six factors is the
maximum number of factors that can be uniquely identified in a
first-order solution with 11 factor indicators (cf. Ledermann, 1937, see
also the Lederman function in the fungible library).

```{r Conscientiousness Parallel Analysis}
## ~~~~~~~~~~~~~~~~~~~~~ ##
#### Parallel Analysis ####
## ~~~~~~~~~~~~~~~~~~~~~ ##

## Maximum number of factors that can be extracted
# Ledermann(numVariables = ncol(scaleData))$numFactors

## Parallel analysis
fa.parallel(x           = scaleData, ## Raw data
            fa          = "fa",      ## Fact analysis only, not PCA
            fm          = "uls",     ## OLS estimation
            SMC         = TRUE,      ## Communality est by sqr multi correlation
            n.iter      = 100,       ## Number of iterations to attempt
            show.legend = FALSE)     ## Hide legend

```

### Empirical Kaiser Criterion

Recall from the manuscript that the empirical Kaiser criterion (EKC)
procedure accounts for the sampling behavior of eigenvalues and the
serial nature of eigenvalues. The results of the EKC procedure
recommended extracting about three factors with the third factor having
a marginally larger eigenvalue than what is expected due to chance.
Thus, either two or three factors represent a plausible range of common
factors to model.

```{r Conscientiousness EKC}
## ~~~~~~~~~~~~ ##
#### EKC Plot ####
## ~~~~~~~~~~~~ ##

ConscEKC <- faEKC(R     = corData,
                  NSubj = nrow(scaleData),
                  Plot  = TRUE)
```

## Bifactor Analysis

A (constrained) hierarchical exploratory bifactor model was fitted to
the data using the Direct Schmid-Leiman (DSL) procedure. Note that the
Schmid-Leiman procedure cannot uniquely estimate loadings on a
second-order general factor from only two (correlated) first-order
factors. Most factor analysis programs therefore take the square root of
the factor correlation to obtain the second-order factor loadings. This
will necessarily bias loadings in an SL transformation. Therefore, a DSL
procedure was applied as it does not fall prey to the same deficiency.

An exploratory version of the DSL procedure (cf. Giordano & Waller,
2020; Waller, 2018) was applied to create the target matrix for the
Procrustian rotation. Specifically, a first-order correlated-factor
pattern was obtained by extracting two factors and applying a geomin
rotation. Next, salient/non-salient loadings were identified in the
factor pattern by applying a threshold of .20 (i.e.,
$\lambda \ge |.20|$). Salient loadings were replaced with $\pm1$
(retaining their original sign) whereas non-salient loadings were set to
zero. No standardization procedures were applied to the geomin rotation
(e.g., Kaiser normalization). All factors were extracted via an ordinary
least squares (OLS) discrepancy function.

### Two Group Factor Solution

By arbitrarily defining factor loadings $< |.30|$ as being trivially
influenced by a latent factor, we can determine which items are related
to which factors. The first group factor was comprised of (in descending
order of factor-loading strength) diligence, achievement, persistence,
industriousness, virtue, deliberateness, and cautiousness. The second
group factor was comprised of (in descending order of factor-loading
strength) Dutifulness, traditionalism, and responsibility. Orderliness
did not fit cleanly in either group factor (though, again, the cutoff
was arbitrary).

```{r Conscientiousness 2 factor Bifactor Model}
## ~~~~~~~~~~~~~~~~~~~~~ ##
#### Bifactor Analyses ####
## ~~~~~~~~~~~~~~~~~~~~~ ##

## Get rid of numbers in rownames so matrix is symmetric
rownames(corData) <- colnames(corData)

## Conduct Direct Schmid-Leiman orthogonalization of a 2nd order model
ConscDSLOutput <- 
  BiFAD(R             = corData,      ## Scale-level corr matrix
        B             = NULL,         ## No user-specified target matrix
        numFactors    = 2,            ## Number of GROUP factors extracted
        facMethod     = "fals",       ## Least squares extraction
        rotate        = "geominQ",    ## Geomin rotation
        salient       = .20,          ## Threshold to create target matrix
        rotateControl = 
          list(numberStarts = 100,    ## Number of random start values
               delta        = .01))   ## Geomin tuning parameter

## Add scale names for interpretability
## NOTE: Item order was NOT sorted above and Procrustes does not alter row order
rownames(ConscDSLOutput$BstarSL) <- rownames(corData)
colnames(ConscDSLOutput$BstarSL) <- c("Conscientiousness", 
                                      "Prudent work orientation",
                                      "Conformity")

## Create an object of the rank-deficient DSL loadings matrix
Consc2FactorDSL <- ConscDSLOutput$BstarSL

## ~~~~~~~~~~~~~~~~~~~~ ##
#### Sort Item Order  ####
## ~~~~~~~~~~~~~~~~~~~~ ##

## Find group factor simple structure (factor loadings in descending order)
## What Holzinger called the 'hallow staircase' pattern
itemOrder <- faSort(fmat     = Consc2FactorDSL,
                    BiFactor = TRUE)$sortOrder ## Ignore 1st factor in sorting

## Order the items in the obtained DSL solution 
Consc2FactorDSL <- Consc2FactorDSL[itemOrder, ]

## Ensure the data correlation matrix has the same order (used later)
corData <- corData[itemOrder, itemOrder]

## Ensure the (standardized) data are in the new order as well
scaleData <- scaleData[, itemOrder]

## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Factor Indicator Statistics  ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Compute the item communalities
Communality <- apply(Consc2FactorDSL^2, 1, sum)

## Compute item explained common variance (I-ECV)
IECV <- apply(Consc2FactorDSL^2, 1, function(x) x[1] / sum(x))

## Combine factor loadings matrix with the item variance metrics
DSLrounded <- cbind(Consc2FactorDSL, Communality, IECV) %>% round(2)

## Add column names for the factors and statistical indices
colnames(DSLrounded) <- c(colnames(Consc2FactorDSL),
                          "$h^2$", 
                          "I-ECV")
```

```{r Conscientiousness 2 Factor Bifactor Table}

## Create table caption, remove linebreaks
TabCaption6 <- c("Direct Schmid-Leiman Two Factor Bifactor Solution of the 
                 Conscientiousness Scales") %>% 
  str_replace("\n", "") %>% 
  str_squish

## Remove extra linebreaks and whitespaces
TabFootnote5 <- c("$h^2$ = item communality; I-ECV = item explained common 
                  variance.") %>% str_replace("\n", "") %>% str_squish()

## Create table using knitr's kable function
kable(DSLrounded,
      caption   = TabCaption6,
      booktabs  = TRUE,
      longtable = FALSE,
      escape    = FALSE,
      linesep   = "") %>%
  
  ## Column header to identify column contents
  add_header_above(c(" " = 2, "Group factors" = 2, "Item indices" = 2)) %>% 
  
  ## Add a footnote
  footnote(general        = TabFootnote5,
           threeparttable = TRUE,
           escape         = FALSE)
```

### Three Group Factor Solution

The three-group-factor bifactor solution was estimated by the
traditional Schmid-Leiman procedure. Second-order general factor
loadings can be uniquely estimated from three first-order factors.
Moreover, Schmid-Leiman tends to produce more accurate parameter
estimates (compared to DSL) as the sample size increases.

The obtained bifactor solution with three group factors is provided
below. The composition of the three group factors, using the same
arbitrary cutoff of .30, is as follows. The first group factor was
comprised of achievement, diligence, persistence, and industriousness.
This group factor is readily interpretable as Industriousness or Work
Orientation. The second group factor was comprised of dutifulness and
traditionalism. This second factor represents the Conformity factor from
the two-group-factor model. The third group factor was comprised of
deliberateness and cautiousness. This last factor can be considered to
measure Prudence. Virtue, responsibility, and orderliness did not fit
cleanly under any of these group factors (though they had modestly
strong general factor correlations; $.44 \le \lambda_g \le .62$).

```{r Conscientiousness Three Factor Bifactor}
## ~~~~~~~~~~~~~~~~~~~~~ ##
#### Bifactor Analyses ####
## ~~~~~~~~~~~~~~~~~~~~~ ##

## Conduct Direct Schmid-Leiman orthogonalization of a 2nd order model
Consc3FactorSL <- 
  SchmidLeiman(R             = corData,        ## Scale-level corr matrix
               numFactors    = c(3, 1),        ## Number of factors per level
               facMethod     = "fals",         ## Least squares extraction
               rotate        = "geominQ",      ## Geomin rotation
               rotateControl =   
                 list(numberStarts = 100,      ## Number of random start values
                      delta        = .01))$B   ## Geomin tuning parameter

## Add scale names for interpretability
## NOTE: Item order was NOT sorted above and Procrustes does not alter row order
rownames(Consc3FactorSL) <- rownames(corData)
colnames(Consc3FactorSL) <- c("Conscientiousness", 
                              "Work orientation",
                              "Conformity",
                              "Prudence")

## ~~~~~~~~~~~~~~~~~~~~ ##
#### Sort Item Order  ####
## ~~~~~~~~~~~~~~~~~~~~ ##

## Find group factor simple structure (factor loadings in descending order)
threeFacItemOrder <- faSort(fmat     = Consc3FactorSL,
                            BiFactor = TRUE)$sortOrder

## Order the items in the obtained DSL solution 
Consc3FactorSL <- Consc3FactorSL[threeFacItemOrder, ]

## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Factor Indicator Statistics  ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Compute the item communalities
Communality <- apply(Consc3FactorSL^2, 1, sum)

## Compute item explained common variance (I-ECV)
IECV <- apply(Consc3FactorSL^2, 1, function(x) x[1] / sum(x))

## Combine factor loadings matrix with the item variance metrics
SLrounded <- cbind(Consc3FactorSL, Communality, IECV) %>% round(2)

## Add column names for the factors and statistical indices
colnames(SLrounded) <- c(colnames(Consc3FactorSL),
                         "$h^2$", 
                         "I-ECV")
```

```{r Conscientiousness Three Factor Bifactor Table}
## Create table caption, remove linebreaks
TabCaption7 <- c("Schmid-Leiman Three Factor Bifactor Solution of the 
                 Conscientiousness Scales") %>% 
  str_replace("\n", "") %>% str_squish()

## Create table using knitr's kable function
kable(SLrounded,
      caption   = TabCaption7,
      booktabs  = TRUE,
      longtable = FALSE,
      escape    = FALSE,
      linesep   = "") %>%
  
  ## Column header to identify column contents
  add_header_above(c(" " = 2, "Group factors" = 3, "Item indices" = 2)) %>% 
  
  ## Add a footnote
  footnote(general        = TabFootnote5,
           threeparttable = TRUE,
           escape         = FALSE)
```

## Model-Based Reliability Analyses ($\omega$)

The table below provides the model-based reliability values (i.e.,
$\omega$ and its cognates) for the two-group-factor bifactor model.

```{r Conscientiousness Omega Computations}
## ~~~~~~~~~~~~~~~~~~~~~~ ##
#### Omega Computations ####
## ~~~~~~~~~~~~~~~~~~~~~~ ##

## Overall omega estimate (all common factors / common + uniqueness)
ConscOmegaTotal <- Omega(Consc2FactorDSL)$OmegaTotal %>% round(2)

## Omega hierarchical (gen factor / common + uniqueness)
ConscOmegaGeneral <- Omega(Consc2FactorDSL)$OmegaGeneral %>% round(2)

## Omega hierarchical subscale: Group Factor 1
GF1 <- c("Diligence", "Achievement", "Persistence", "Industriousness", 
         "Virtue", "Deliberateness", "Cautiousness")

## Compute the uniqueness values (i.e., 1 - communalities)
GF1Uniqueness <- 1 - (Consc2FactorDSL[GF1, ]^2 %>% 
                        apply(1, sum)) ## 1 minus communalities
## Compute numerator for Omega subscale
GF1Numerator <- sum(Consc2FactorDSL[GF1, "Prudent work orientation"])^2 

## Compute denominator for Omega subscale
GF1Denominator <- cbind(Consc2FactorDSL[GF1, c("Conscientiousness", 
                                               "Prudent work orientation")], 
                        GF1Uniqueness) %>% 
  apply(2, function(x) sum(x)^2) %>% sum

## Omega subscale values
GF1SubscaleOmega <- (GF1Numerator / GF1Denominator) %>% round(2)

## Omega hierarchical subscale: Group factor 2
GF2 <- c("Dutifulness", "Traditionalism", "Responsibility")

## Compute the uniqueness values (i.e., 1 - communalities)
GF2Uniqueness <- 1 - (Consc2FactorDSL[GF2, ]^2 %>% 
                        apply(1, sum)) ## 1 minus communalities
GF2Numerator <- sum(Consc2FactorDSL[GF2, "Conformity"])^2 
GF2Denominator <- cbind(Consc2FactorDSL[GF2, c("Conscientiousness", 
                                               "Conformity")], 
                        GF2Uniqueness) %>% 
  apply(2, function(x) sum(x)^2) %>% sum
GF2SubscaleOmega <- (GF2Numerator / GF2Denominator) %>% round(2)

```

```{r Conscientiousness Omega Table}
## Create table caption
TabCaption8 <- c("Model Based Reliability Indices for the Conscientiousness 
                 Bifactor Model") %>% str_replace("\n", "") %>% str_squish()


## Create a table of the omega values
data.frame("Overall"                  = ConscOmegaTotal,
           "Conscientiousness"        = ConscOmegaGeneral,
           "Prudent work orientation" = GF1SubscaleOmega,
           "Conformity"               = GF2SubscaleOmega) %>% 
  
  ## Transpose the data.frame to be a column vector
  t() %>% 
  
  ## Create a table in LaTeX
  kable(caption   = TabCaption8,
        booktabs  = TRUE,
        longtable = FALSE,
        escape    = FALSE,
        linesep   = "") %>% 
  
  ## Row headings
  pack_rows("Omega full scale", 1, 1) %>% 
  pack_rows("Omega hierarchical", 2, 2) %>% 
  pack_rows("Omega hierarchical subscale", 3, 4) %>% 
  
  ## Create extra column width in the first column
  column_spec(column = 1, 
              width  = "2.5in") 
```

## Factor Determinacy

The values reported below are the factor indeterminacy values. These
values represent the correlation between factor scores and the factors.
The values range between zero and unity with larger values indicating
that factor scores are better determined. Empirically, factor
determinacy is a function of (a) factor loading strength and (b) the
number of salient factor indicators for a given factor. General factors,
by definition, have more salient loadings than the group factors but
there is no guarantee that general factors are better determined (as
shown below). Moreover, recommendations suggest that factor determinacy
values less than .90 are ill-suited for practical applications.

Nevertheless, we computed factor scores for illustrative purposes.

```{r Conscientiousness factor determinacy}
## ~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Factor Indeterminacy ####
## ~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Verify the model and correlation matrix are similarly ordered
if (all.equal(rownames(Consc2FactorDSL), rownames(corData)) != TRUE) {
  stop("Variables are not in the same order")
} # END if (all.equal(rownames(Consc2FactorDSL), rownames(corData)) != TRUE) 

## Compute Guttman's (1995) factor indeterminacy index
ConscFacIndeter <- 
  factorIndeterminacy(Lambda   = Consc2FactorDSL,
                      PhiMat   = diag(ncol(Consc2FactorDSL)),
                      SampCorr = corData) %>% 
  as.data.frame()

## Factor score indeterminacy metric (rho)
rho <- ConscFacIndeter

## Add rownames to the data frame for later tabling
rownames(ConscFacIndeter) <- colnames(Consc2FactorDSL)

## Rho squared: Shared variance between factor scores and factors
rhoSqr <- ConscFacIndeter^2

## Minimum possible correlation between sets of factor scores 
minCorr <- 2 * rhoSqr - 1

## Create table caption
TabCaption9 <- c("Factor Determinacy Indicies for the Conscientiousness 
                 Bifactor Model") %>% str_replace("\n", "") %>% str_squish()

## Create table footnote
TabFootnote6 <- c("$\\\\rho$ = correlation between factor scores and factors, 
                  $\\\\rho^2$ = squared correlation between factor scores and 
                  factors, MPC = minimum possible correlation between sets of 
                  factor scores.") %>% str_replace_all("\n", "") %>% str_squish

data.frame(rho,
           rhoSqr,
           minCorr) %>% 
  kable(caption   = TabCaption9,
        booktabs  = TRUE,
        longtable = FALSE,
        escape    = FALSE,
        col.names = c("$\\rho$", "$\\rho^2$", "MPC"),
        digits    = 3,
        linesep   = "") %>% 
  kable_styling() %>% 
  footnote(general = TabFootnote6,
           threeparttable = TRUE,
           escape         = FALSE)

```

## Factor Score Estimation

The following section produces code illustrating how factor scores were
estimated. Namely, two methods were applied: (a) approximated factor
scores by summing unit-weighted scores and (b) factor scores estimated
via Thurstone's regression-based approach. Unit-weighted scores are
inexact and, in simulation work, typically yield the least accurate
estimates of the true factor scores in moderate to larger sample sizes.
Regression-based factor scores frequently yield correlated factor scores
but tend to more accurately recover the true factor scores.

To compute the unit-weighted sum score, the same arbitrary cutoff value
from earlier (i.e., $\lambda \ge |.30|$) was applied. The user-written
function includes an argument to change this threshold, which may (and
likely will) alter factor score estimates (and their interpretation).
For instance, setting the cutoff value to .28 will include orderliness
as a contributor to the first group factor. At .30, orderliness is not
included as a marker of either group factor.

```{r Conscientiousness factor score estimates}
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Factor Score Estimation ####
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Unit-Weighted Sum Score
UnitWeightSumFS <-
  UnitWeightFacScore(stndData      = scaleData,
                     Lambda        = Consc2FactorDSL,
                     FacLoadCutoff = .30)

## Extract the correlation between the factor scores
CorrUnitWeight <- UnitWeightSumFS$r.scores

## Thurstone "exact regression" (Grice, 2001) factor score estimates
ThurstoneFS <-
  faScores(X        = scaleData,
           Loadings = Consc2FactorDSL,
           Method   = "Thurstone")$fscores 

## Create the factor score correlation matrix
CorrThurstone <- cor(ThurstoneFS)

## Find the correlation between factor scores across the 2 methods
CorrFSAgreement <- rep(NA, 3)
for (iFS in seq_len(length(CorrFSAgreement))) {
  CorrFSAgreement[iFS] <- cor(UnitWeightSumFS$scores[, iFS],
                              ThurstoneFS[, iFS])
} # END for (iFS in seq_len(length(CorrFSAgreement))) 

## Compile these correlations into one matrix
FScorr <- matrix(NA, nrow = ncol(Consc2FactorDSL), ncol = ncol(Consc2FactorDSL))

## Lower triangle is unit weighting FS intercorrelations
FScorr[lower.tri(FScorr)] <- CorrUnitWeight[lower.tri(CorrUnitWeight)]

## Upper triangle is thurstone FS intercorrelations
FScorr[upper.tri(FScorr)] <- CorrThurstone[upper.tri(CorrThurstone)]

## Diagonal is FS correlation across methods
diag(FScorr) <- CorrFSAgreement

## Convert the correlation matrix into a data frame for tabling purposes
FScorr %<>% as.data.frame
colnames(FScorr) <- rownames(FScorr) <- colnames(Consc2FactorDSL)

```

```{r Table the factor correlation values}

## Set a caption for the upcoming table
TabCaption10 <- c("Values in the lower triangle represent the correlations 
                  between unit-weighted estimates of the factor scores. Values 
                  in the upper triangle represent the correlations between 
                  Thurstone's regression-based factor score estimates. Values 
                  in the diagonal represent the correlation of scores on the 
                  same factor by different estimation methods.") %>% 
  str_replace_all("\n", "") %>% str_squish

## Print the table of results
kable(FScorr,
      caption   = "Intercorrelation between factor score estimates",
      booktabs  = TRUE,
      longtable = FALSE,
      digits    = 3,
      linesep   = "") %>% 
  kable_styling() %>% 
  footnote(general        = TabCaption10,
           threeparttable = TRUE)

```

## Factor Determinacy in the Three Group Factor Model

In this section, we report the same factor score metrics as above for
the conscientiousness bifactor model with two group factors.

### Factor Determinacy

Factor determinacy values are reported below for the conscientiousness
bifactor model with three group factors (i.e., work orientation,
conformity, and prudence). Here, the general conscientiousness factor is
more determinate than two of the group factors: work orientation and
prudence. These factors (as detailed above) represent a splitting of the
prudent work orientation factor found in the bifactor model with two
group factors. Thus, it is not a surprise that conformity has the
highest determinacy values and the other two factors witnessed a
noteable drop in factor determinacy values.

```{r Three Group Fac Factor Indetermincy Metric}
## ~~~~~~~~~~~~~~~~~~~~~~~~ ##
#### Factor Indeterminacy ####
## ~~~~~~~~~~~~~~~~~~~~~~~~ ##

## Ensure correlation matrix is conformable with the factor pattern matrix
corData3FacOrder <- corData[rownames(Consc3FactorSL),
                            rownames(Consc3FactorSL)]

## Return an error if variables are mis-aligned in the two matrices
if (all.equal(rownames(corData3FacOrder), rownames(Consc3FactorSL)) != TRUE) {
  stop("Variables are not in the same order.")
} # END if (all.equal(rownames(corData3FacOrder), rownames(Consc3FactorSL)) != TRUE) 

## Compute Guttman's (1995) factor indeterminacy index
Consc3FacIndeter <- 
  factorIndeterminacy(Lambda   = Consc3FactorSL,
                      PhiMat   = diag(ncol(Consc3FactorSL)),
                      SampCorr = corData3FacOrder) %>% 
  as.data.frame()

## Factor score indeterminacy metric (rho)
rho <- Consc3FacIndeter

## Add row names for later tabling
rownames(Consc3FacIndeter) <- colnames(Consc3FactorSL)

## Rho squared: Shared variance between factor scores and factors
rhoSqr <- Consc3FacIndeter^2

## Minimum possible correlation between sets of factor scores 
minCorr <- 2 * rhoSqr - 1

## Set table caption
TabCaption10 <- c("Factor Determinacy Indicies for the Three Group Factor 
                  Conscientiousness Bifactor Model") %>% 
  str_replace("\n", "") %>% str_squish()

data.frame(rho,
           rhoSqr,
           minCorr) %>% 
  kable(caption   = TabCaption10,
        booktabs  = TRUE,
        longtable = FALSE,
        escape    = FALSE,
        col.names = c("$\\rho$", "$\\rho^2$", "MPC"),
        digits    = 3,
        linesep   = "") %>% 
  kable_styling() %>% 
  footnote(general = TabFootnote6,
           threeparttable = TRUE,
           escape         = FALSE)

```

<!--chapter:end:Supplemental_Materials_1.Rmd-->

